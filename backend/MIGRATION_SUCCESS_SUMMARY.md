# ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!

**–î–∞—Ç–∞:** 2025-12-18
**–í–µ—Ä—Å–∏—è:** 1.0

---

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. **–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ –ë–î**

–í—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ 3 –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü—É `specialists_examinations`:

```sql
ALTER TABLE specialists_examinations
ADD COLUMN os_vision_without_correction NUMERIC(3, 2);

ALTER TABLE specialists_examinations
ADD COLUMN od_vision_without_correction NUMERIC(3, 2);

ALTER TABLE specialists_examinations
ADD COLUMN dentist_json JSONB;
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
docker exec emedosmotr_db psql -U admin -d emedosmotr -c "\d specialists_examinations"
```

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—è —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã!

---

### 2. **–û–±–Ω–æ–≤–ª–µ–Ω—ã –º–æ–¥–µ–ª–∏ SQLAlchemy**

#### **–§–∞–π–ª:** `backend/app/models/medical.py`

–î–æ–±–∞–≤–ª–µ–Ω—ã:
- `os_vision_without_correction: Mapped[Optional[float]]` - –∑—Ä–µ–Ω–∏–µ –ª–µ–≤–æ–≥–æ –≥–ª–∞–∑–∞
- `od_vision_without_correction: Mapped[Optional[float]]` - –∑—Ä–µ–Ω–∏–µ –ø—Ä–∞–≤–æ–≥–æ –≥–ª–∞–∑–∞
- `dentist_json: Mapped[Optional[dict]]` - –∑—É–±–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ (JSONB)

–î–æ–±–∞–≤–ª–µ–Ω—ã **property-–∞–ª–∏–∞—Å—ã** –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å API:
- `valid_category` ‚Üí `doctor_category`
- `diagnosis_accompany_id` ‚Üí `icd10_code`
- `additional_act_comment` ‚Üí `additional_comment`
- `complain` ‚Üí `complaints`
- `med_commission_member` ‚Üí `specialty_ru`

#### **–§–∞–π–ª:** `backend/app/models/conscript.py`

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å `AnthropometricData` –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ë–î:
- –ò–∑–º–µ–Ω–µ–Ω —Ç–∏–ø `id` —Å `Integer` –Ω–∞ `UUID`
- –ó–∞–º–µ–Ω–µ–Ω–æ `conscript_id` –∏ `draft_id` –Ω–∞ `conscript_draft_id: UUID`
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ–ª—è –∑—Ä–µ–Ω–∏—è: `visual_acuity_left/right` –≤–º–µ—Å—Ç–æ `vision_left/right`
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ–ª—è –¥–∞–≤–ª–µ–Ω–∏—è: `blood_pressure_systolic/diastolic` –≤–º–µ—Å—Ç–æ `blood_pressure`
- –î–æ–±–∞–≤–ª–µ–Ω—ã: `head_circumference`, `measured_by`

---

### 3. **–°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å –º–∞–ø–ø–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö**

#### **–§–∞–π–ª:** `backend/app/services/external_ai_mapper.py`

**–§—É–Ω–∫—Ü–∏—è:** `prepare_external_ai_request(conscript_draft_id, db)`

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–∑—ã–≤–Ω–∏–∫–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç –≤–Ω–µ—à–Ω–µ–≥–æ API:

```python
{
  "conscript_draft": {
    "id": "uuid",
    "conscript_id": "–ò–ò–ù –ø—Ä–∏–∑—ã–≤–Ω–∏–∫–∞",
    "draft": "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑—ã–≤–∞",
    "conscript_status": "completed",
    "category_graph": {"graph": 1, "id": 1}
  },
  "anthropometic_data": {
    "height": 175.0,
    "weight": 68.0,
    "bmi": 22.2
  },
  "specialists_examinations": [
    {
      "med_commission_member": "–û—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥",
      "conscript_draft_id": "uuid",
      "valid_category": "–ê",
      "diagnosis_accompany_id": "Z00.0",
      "objective_data": "...",
      "special_research_results": "...",
      "additional_act_comment": null,
      "complain": "...",
      "anamnesis": "...",
      "os_vision_without_correction": "1.0",
      "od_vision_without_correction": "0.8",
      "dentist_json": {...}
    }
  ]
}
```

---

### 4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞**

**–§–∞–π–ª:** `backend/test_external_api_mapper.py`

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞:**
```
============================================================
‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù –£–°–ü–ï–®–ù–û!
============================================================

–ü—Ä–∏–∑—ã–≤–Ω–∏–∫ ID: 990101300001
–ü—Ä–∏–∑—ã–≤: –í–µ—Å–Ω–∞ 2025 - –°–ª—É—á–∞–π 1
–ó–∞–∫–ª—é—á–µ–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤: 9

üí° –î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ –≤–Ω–µ—à–Ω–∏–π AI —Å–µ—Ä–≤–µ—Ä
```

---

## üéØ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å API –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|------------|--------|
| **–ê–Ω—Ç—Ä–æ–ø–æ–º–µ—Ç—Ä–∏—è** | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| `height`, `weight`, `bmi` | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| **–î–∞–Ω–Ω—ã–µ –≤—Ä–∞—á–µ–π** | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| 10 –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–ª–µ–π | ‚úÖ –ì–æ—Ç–æ–≤–æ (—á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å—ã) |
| –ó—Ä–µ–Ω–∏–µ –æ—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥–∞ (OD/OS) | ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ |
| –ó—É–±–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∞ | ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ |
| **conscript_id (–ò–ò–ù)** | ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| –ü–æ–ª—É—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `draft.conscript.iin` | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ:** 4
- **–ü–æ–ª–µ–π –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ë–î:** 3
- **Property-–∞–ª–∏–∞—Å–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:** 5
- **–ù–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:** 1 (external_ai_mapper)
- **–¢–µ—Å—Ç–æ–≤—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤:** 1

---

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### **–ü—Ä–∏–º–µ—Ä 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ API**

```python
from app.services.external_ai_mapper import prepare_external_ai_request
from uuid import UUID

async def send_to_external_ai(draft_id: UUID):
    async with get_db() as db:
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        api_data = await prepare_external_ai_request(draft_id, db)

        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–µ—Ä
        async with httpx.AsyncClient() as client:
            response = await client.post(
                "http://external-ai-server/analyze",
                json=api_data,
                timeout=60.0
            )

        return response.json()
```

### **–ü—Ä–∏–º–µ—Ä 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥–∞**

```python
examination = SpecialistExamination(
    conscript_draft_id=draft_id,
    specialty="ophthalmologist",
    specialty_ru="–û—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥",

    # –ù–æ–≤—ã–µ –ø–æ–ª—è
    os_vision_without_correction=1.0,  # –õ–µ–≤—ã–π –≥–ª–∞–∑
    od_vision_without_correction=0.8,  # –ü—Ä–∞–≤—ã–π –≥–ª–∞–∑

    doctor_category="–ê",
    icd10_code="Z00.0",
    conclusion_text="–ó—Ä–µ–Ω–∏–µ –≤ –Ω–æ—Ä–º–µ"
)
```

### **–ü—Ä–∏–º–µ—Ä 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–ª–∏–∞—Å–æ–≤**

```python
# –°—Ç–∞—Ä—ã–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
print(exam.doctor_category)  # "–ê"
print(exam.icd10_code)       # "Z00.0"

# –ù–æ–≤—ã–π –∫–æ–¥ —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (—á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å—ã)
print(exam.valid_category)           # "–ê"
print(exam.diagnosis_accompany_id)   # "Z00.0"
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (3 –Ω–æ–≤—ã—Ö –ø–æ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω—ã)
- [x] –ú–æ–¥–µ–ª–∏ SQLAlchemy –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [x] Property-–∞–ª–∏–∞—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [x] –°–µ—Ä–≤–∏—Å –º–∞–ø–ø–∏–Ω–≥–∞ —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [x] –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ
- [x] Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- [x] –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å 100%

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏**

```sql
-- –¢–∞–±–ª–∏—Ü–∞: specialists_examinations
Column                         | Type
-------------------------------|-------------
os_vision_without_correction   | numeric(3,2)
od_vision_without_correction   | numeric(3,2)
dentist_json                   | jsonb
```

### **Property-–∞–ª–∏–∞—Å—ã –≤ –º–æ–¥–µ–ª—è—Ö**

```python
@property
def valid_category(self) -> str:
    """–ê–ª–∏–∞—Å: doctor_category ‚Üí valid_category"""
    return self.doctor_category

@property
def diagnosis_accompany_id(self) -> str:
    """–ê–ª–∏–∞—Å: icd10_code ‚Üí diagnosis_accompany_id"""
    return self.icd10_code
```

---

## üìù –í–∞–∂–Ω—ã–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è

### **1. –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**

‚úÖ **–í–µ—Å—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π!**

- –ù–æ–≤—ã–µ –ø–æ–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ (`nullable=True`)
- –°—Ç–∞—Ä—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- –ê–ª–∏–∞—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ

### **2. –ò–ò–ù –ø—Ä–∏–∑—ã–≤–Ω–∏–∫–∞ (conscript_id)**

‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è:**

```
anthropometric_data
  ‚Üí conscript_draft_id
  ‚Üí conscript_drafts
  ‚Üí conscript_id
  ‚Üí conscripts
  ‚Üí iin (–ò–ò–ù –ø—Ä–∏–∑—ã–≤–Ω–∏–∫–∞)
```

–í API –∑–∞–ø—Ä–æ—Å–µ:
```json
{
  "conscript_draft": {
    "conscript_id": "990101300001"  ‚Üê –ò–ò–ù –∏–∑ draft.conscript.iin
  }
}
```

### **3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –º–∞–ø–ø–µ—Ä–∞:
```bash
docker exec emedosmotr_backend python test_external_api_mapper.py
```

---

## üéâ –ò—Ç–æ–≥–∏

### **–ë—ã–ª–æ:**
- ‚ùå –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–µ–π –ë–î –∏ API
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–µ–π –¥–ª—è –æ—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥–∞ –∏ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∞
- ‚ùå –ù–µ—Ç —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### **–°—Ç–∞–ª–æ:**
- ‚úÖ 100% —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å —Ñ–æ—Ä–º–∞—Ç–æ–º –≤–Ω–µ—à–Ω–µ–≥–æ API
- ‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω—ã
- ‚úÖ –ì–æ—Ç–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –º–∞–ø–ø–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

---

## üìû –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–û–±–Ω–æ–≤–∏—Ç—å frontend —Ñ–æ—Ä–º—ã** –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –æ –∑—Ä–µ–Ω–∏–∏ –∏ –∑—É–±–Ω–æ–π —Ñ–æ—Ä–º—É–ª—ã
2. **–°–æ–∑–¥–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç FastAPI** –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –≤–Ω–µ—à–Ω–∏–π AI
3. **–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ç–≤–µ—Ç–∞** –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ AI —Å–µ—Ä–≤–µ—Ä–∞
4. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –≤–Ω–µ—à–Ω–µ–º—É API

---

**–ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞:** ‚úÖ –£—Å–ø–µ—à–Ω–æ
**–î–∞—Ç–∞:** 2025-12-18
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
