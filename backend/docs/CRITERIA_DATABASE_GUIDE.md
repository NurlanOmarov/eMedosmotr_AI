# Руководство по базе данных медицинских критериев

## Обзор

База данных медицинских критериев содержит детальные клинические критерии для определения категорий годности к военной службе согласно **Приказу Министра обороны Республики Казахстан №722 от 21 декабря 2020 года**.

## Файл базы данных

**Расположение:** `/backend/data/emedosmotr.db` (SQLite) или PostgreSQL база в Docker-контейнере

**Основная таблица:** `point_criteria`

### Структура таблицы point_criteria

```sql
CREATE TABLE point_criteria (
    id SERIAL PRIMARY KEY,
    article INTEGER NOT NULL,           -- Номер статьи (1-89)
    subpoint VARCHAR(10) NOT NULL,      -- Подпункт статьи (1, 2, 3, 4)
    description TEXT NOT NULL,          -- Конкретный медицинский критерий
    graph_1 VARCHAR(10),                -- Категория для графы I
    graph_2 VARCHAR(10),                -- Категория для графы II
    graph_3 VARCHAR(10),                -- Категория для графы III
    graph_4 VARCHAR(10)                 -- Категория для графы IV
);
```

### Таблица embeddings

```sql
CREATE TABLE embeddings (
    id SERIAL PRIMARY KEY,
    criteria_id INTEGER REFERENCES point_criteria(id),
    embedding vector(1536)              -- OpenAI text-embedding-3-small
);
```

## Статистика базы данных

- **Всего критериев:** 884
- **Статей:** 89 (все статьи из Приказа №722)
- **Критериев с embeddings:** 884/884 (100%)
- **Дубликатов:** 0

## Проделанная работа

### Этап 1: Извлечение критериев из Приложения 2

Из документа **"ПРИЛОЖЕНИЕ_2_Пояснения_к_Требованиям.txt"** были извлечены конкретные медицинские критерии для каждой статьи и подпункта.

**Примеры извлеченных критериев:**

#### Статья 43 (Артериальная гипертензия)
- **До:** "со значительным нарушением функций"
- **После:** "артериальная гипертензия 3 степени с преобладанием в клинической картине одного из тяжелых сосудистых расстройств (хроническая сердечная недостаточность II-IV ФК, инфаркт миокарда, расслаивающая аневризма аорты, геморрагический инсульт)"

#### Статья 72 (Мочеполовая система)
- **До:** "с умеренным нарушением функций"
- **После:** "мочекаменная болезнь с частыми (три и более раза в год) приступами почечной колики, отхождением камней, умеренным нарушением выделительной функции почек"

#### Статья 80 (Врожденные аномалии)
- **До:** общие описания пороков
- **После:** 72 конкретных критерия с количественными показателями
  - "пролапс митрального или других клапанов сердца III степени (9 миллиметров и более)"
  - "О-образное искривление ног при расстоянии между выступами внутренних мыщелков бедренных костей более 20 сантиметров"

### Этап 2: Создание SQL-скриптов

Для каждой статьи были созданы SQL-скрипты в директории `/backend/scripts/`:

**Исправленные статьи:**

1. `fix_article_21.sql` - Эпилепсия, мигрень (14 критериев)
2. `fix_article_34.sql` - Нарушения рефракции (4 критерия)
3. `fix_article_35.sql` - Понижение зрения (4 критерия)
4. `fix_article_42.sql` - Болезни сердца (60 критериев)
5. `fix_article_43.sql` - Артериальная гипертензия (12 критериев)
6. `fix_article_48.sql` - Болезни носа, пазух (10 критериев)
7. `fix_article_49.sql` - Болезни гортани (7 критериев)
8. `fix_article_51.sql` - Бронхиальная астма (6 критериев)
9. `fix_article_54.sql` - Пародонтит (4 критерия)
10. `fix_article_58.sql` - Язвенная болезнь (28 критериев)
11. `fix_article_66.sql` - Болезни позвоночника (30 критериев)
12. `fix_article_67.sql` - Дефекты пальцев (29 критериев)
13. `fix_article_72.sql` - Мочеполовая система (28 критериев)
14. `fix_article_75.sql` - Эндометриоз (4 критерия)
15. `fix_article_80.sql` - Врожденные аномалии (72 критерия)
16. `fix_article_82.sql` - Переломы (34 критерия)
17. `fix_article_85.sql` - Последствия отравлений (9 критериев)
18. `fix_article_87.sql` - Физическое развитие (4 критерия)
19. `fix_article_88.sql` - Энурез (1 критерий)
20. `fix_article_29.sql` - Болезни век (11 критериев)
21. `fix_article_33.sql` - Болезни мышц глаза (4 критерия)
22. `fix_article_39.sql` - Вестибулярные расстройства (3 критерия)
23. `fix_article_46.sql` - СВДССС (4 критерия)

**Всего:** 23 статьи с конкретными медицинскими критериями

### Этап 3: Генерация embeddings

Для каждого критерия генерируется векторное представление (embedding) с использованием модели **OpenAI text-embedding-3-small (1536 измерений)**.

**Формат текста для embedding:**
```
Статья {article}, подпункт {subpoint}: {description}
```

**Пример:**
```
Статья 43, подпункт 1: артериальная гипертензия 3 степени с преобладанием в клинической картике одного из тяжелых сосудистых расстройств
```

**Скрипт генерации:** `/backend/scripts/generate_embeddings.py`

### Этап 4: Оптимизация и очистка

- Удалены дубликаты критериев
- Объединены разбитые описания
- Исправлены неполные записи
- Проверена консистентность данных

## Как система использует критерии

### 1. Семантический поиск по симптомам

Когда пользователь вводит симптомы или диагноз, система:

1. **Создает embedding** описания пациента
2. **Выполняет векторный поиск** в таблице embeddings используя pgvector
3. **Находит наиболее релевантные критерии** по косинусному сходству

```python
# Пример из backend/app/services/classification_service.py
async def find_relevant_criteria(self, symptoms: str) -> List[Criterion]:
    # Генерация embedding для симптомов
    symptom_embedding = await self.openai_service.create_embedding(symptoms)

    # Поиск похожих критериев
    query = """
        SELECT pc.*,
               1 - (e.embedding <=> $1::vector) as similarity
        FROM point_criteria pc
        JOIN embeddings e ON e.criteria_id = pc.id
        WHERE 1 - (e.embedding <=> $1::vector) > 0.7
        ORDER BY similarity DESC
        LIMIT 10
    """

    return await self.db.fetch(query, symptom_embedding)
```

### 2. Определение категории годности

На основе найденных критериев система определяет:

- **Статью** - номер статьи требований
- **Подпункт** - степень тяжести заболевания
- **Категории годности** для каждой графы (I, II, III, IV)

**Категории годности:**
- **А** - годен к военной службе
- **Б** - годен к военной службе с незначительными ограничениями
- **В** - ограниченно годен к военной службе
- **Г** - временно не годен к военной службе
- **Д** - ограниченно годен к военной службе в военное время
- **Е** - не годен к военной службе
- **НГ** - не годен
- **ИНД** - индивидуальная оценка

### 3. Формирование медицинского заключения

Система генерирует структурированное заключение:

```json
{
  "article": 43,
  "subpoint": "1",
  "diagnosis": "Артериальная гипертензия 3 степени",
  "matched_criteria": "артериальная гипертензия 3 степени с преобладанием...",
  "fitness_categories": {
    "graph_1": "Е",
    "graph_2": "Е",
    "graph_3": "Д",
    "graph_4": "НГ"
  },
  "similarity": 0.92,
  "explanation": "По статье 43, подпункт 1..."
}
```

### 4. RAG (Retrieval-Augmented Generation)

Для генерации детальных пояснений система использует найденные критерии как контекст для LLM:

```python
async def generate_explanation(self, criteria: Criterion, patient_data: dict):
    context = f"""
    Статья: {criteria.article}
    Подпункт: {criteria.subpoint}
    Критерий: {criteria.description}
    Категории: I-{criteria.graph_1}, II-{criteria.graph_2}, III-{criteria.graph_3}, IV-{criteria.graph_4}
    """

    prompt = f"""
    На основе следующего медицинского критерия:
    {context}

    Пациент: {patient_data}

    Сформируй медицинское заключение...
    """

    return await self.llm.generate(prompt)
```

## Преимущества детализированных критериев

### До улучшения:
```sql
description: "со значительным нарушением функций"
```
❌ Неоднозначно
❌ Требует экспертной оценки
❌ Низкая точность AI-классификации

### После улучшения:
```sql
description: "артериальная гипертензия 3 степени с преобладанием в клинической
картике одного из тяжелых сосудистых расстройств (хроническая сердечная
недостаточность II-IV ФК, инфаркт миокарда, расслаивающая аневризма аорты,
геморрагический инсульт, генерализованное сужение артерий сетчатки с
кровоизлияниями или экссудатами на глазном дне и отеком диска зрительного
нерва, ХБП 4 стадии и выше)"
```
✅ Конкретные клинические признаки
✅ Количественные показатели
✅ Высокая точность AI-классификации
✅ Прозрачность решения

## Легитимные шаблонные описания

15 статей остались с общими описаниями, так как:

1. **Временные состояния** (28, 36, 41, 47, 52, 61, 78, 86)
   - Категория определяется после завершения лечения
   - Зависит от динамики состояния

2. **Ссылки на другие статьи** (32, 37, 40, 53, 63, 70, 79)
   - Категория определяется по основному заболеванию
   - Освидетельствование по функции органа (оценивается другими статьями)

## Обслуживание базы данных

### Обновление критериев

Если требуется обновить критерии для статьи:

```bash
# 1. Создайте SQL-скрипт
nano backend/scripts/fix_article_XX.sql

# 2. Примените изменения
docker exec -i emedosmotr_db psql -U admin -d emedosmotr < backend/scripts/fix_article_XX.sql

# 3. Сгенерируйте embeddings
docker-compose exec backend python scripts/generate_embeddings.py
```

### Проверка консистентности

```sql
-- Проверка дубликатов
SELECT description, article, COUNT(*)
FROM point_criteria
GROUP BY description, article
HAVING COUNT(*) > 1;

-- Проверка критериев без embeddings
SELECT COUNT(*)
FROM point_criteria pc
LEFT JOIN embeddings e ON e.criteria_id = pc.id
WHERE e.id IS NULL;

-- Статистика по статьям
SELECT article, COUNT(*) as criteria_count
FROM point_criteria
GROUP BY article
ORDER BY article;
```

### Резервное копирование

```bash
# PostgreSQL
docker exec emedosmotr_db pg_dump -U admin emedosmotr > backup_$(date +%Y%m%d).sql

# Восстановление
docker exec -i emedosmotr_db psql -U admin -d emedosmotr < backup_20231209.sql
```

## Источники данных

1. **Приказ МО РК №722** от 21 декабря 2020 года
2. **Приложение 2** - Пояснения к Требованиям по определению категорий годности
3. Расположение: `/справочник приказ 722/ПРИЛОЖЕНИЕ_2_Пояснения_к_Требованиям.txt`

## Версионирование

- **Версия базы:** 2.0
- **Дата последнего обновления:** 9 декабря 2025
- **Обновлено критериев:** 884
- **Embeddings:** 100%

## Контакты и поддержка

При вопросах по работе с базой данных критериев обращайтесь к документации:
- `/backend/docs/API.md` - API для работы с критериями
- `/backend/scripts/generate_embeddings.py` - скрипт генерации embeddings
- `/backend/app/services/classification_service.py` - сервис классификации
