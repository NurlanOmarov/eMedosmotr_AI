# Краткая справка по логике проверок ВВК

## Схема проверок (визуальная)

```
ЗАКЛЮЧЕНИЕ ВРАЧА
       │
       │ содержит
       │
       ├─► Диагноз (МКБ-10)
       ├─► Анамнез (история болезни)
       ├─► Объективные данные
       └─► Категорию годности (от врача)

       ↓

1️⃣  ОПРЕДЕЛЕНИЕ СТАТЬИ И ПОДПУНКТА

    МКБ-10 код ──────────────────────┐
                                     │
    Параметры (степень, стадия) ─────┤─► Статья Приказа №722
                                     │
    Анамнез (тяжесть, течение) ──────┘

    ↓

    Статья + Параметры ──────────────► Подпункт (1, 2, 3, 4, 5...)

       ↓

2️⃣  ВАЛИДАЦИЯ ПОДПУНКТА

    Подпункт существует в справочнике? ───► ДА: продолжаем
                                       └─► НЕТ: confidence < 0.3, ошибка

    Все параметры указаны? ──────────────► ДА: продолжаем
                                       └─► НЕТ: data_insufficiency = true

       ↓

3️⃣  ОПРЕДЕЛЕНИЕ КАТЕГОРИИ ГОДНОСТИ

    Статья + Подпункт + График ──────► Категория из справочника
                                        (НЕ от AI!)

       ↓

4️⃣  СРАВНЕНИЕ С КАТЕГОРИЕЙ ВРАЧА

    Категория ИИ = Категория врача? ─► ДА: MATCH ✅
                                     └─► НЕТ: MISMATCH ⚠️
```

## Таблица проверок

| Проверка | Что сравнивается | Ожидаемый результат | Возможные проблемы |
|----------|------------------|---------------------|-------------------|
| **1. Диагноз ↔ Анамнез** | Соответствие диагноза описанию в анамнезе | Данные подтверждают друг друга | Противоречия, недостаток информации |
| **2. Диагноз ↔ Подпункт** | Параметры диагноза критериям подпункта | Параметры точно соответствуют | Несоответствие параметров, нет нужных данных |
| **3. Подпункт ↔ Категория** | Подпункт из справочника → категория | Категория определена из справочника | Подпункт не существует в справочнике |
| **4. Категория ИИ ↔ Категория врача** | Категория из справочника vs категория врача | Категории совпадают | Ошибка врача, недостаток данных |
| **5. Анамнез ↔ Категория** | Тяжесть по анамнезу соответствует категории | Тяжелое течение → более строгая категория | Занижена/завышена тяжесть |

## Примеры соответствий и несоответствий

### ✅ Полное соответствие

```
Диагноз: Миопия средней степени (МКБ-10: H52.1)
Параметры: OD -4.5D, OS -4.0D
Анамнез: Носит очки постоянно с 12 лет

✅ Диагноз ↔ Анамнез:
   Миопия подтверждается ношением очков с детства

✅ Диагноз ↔ Подпункт:
   3.0-6.0D → Статья 34, подпункт 4 (точное соответствие)

✅ Подпункт ↔ Категория:
   Статья 34, подпункт 4, граф 1 → Категория Б (из справочника)

✅ Категория ИИ ↔ Категория врача:
   ИИ: Б, Врач: Б (совпадают)

✅ Анамнез ↔ Категория:
   Стабильное течение без осложнений → Категория Б корректна

Итог: MATCH, риск LOW
```

### ❌ Несоответствие (ошибка врача)

```
Диагноз: Миопия средней степени (МКБ-10: H52.1)
Параметры: OD -5.0D, OS -4.5D
Анамнез: Носит очки постоянно с 13 лет

✅ Диагноз ↔ Анамнез:
   Миопия подтверждается

✅ Диагноз ↔ Подпункт:
   3.0-6.0D → Статья 34, подпункт 4

✅ Подпункт ↔ Категория:
   Статья 34, подпункт 4, граф 1 → Категория Б

❌ Категория ИИ ↔ Категория врача:
   ИИ: Б, Врач: А (НЕ совпадают!)

✅ Анамнез ↔ Категория:
   Стабильное течение → Категория Б корректна

Итог: MISMATCH, риск HIGH
Причина: Врач ошибся, поставил А вместо Б
```

### ⚠️ Недостаточно данных

```
Диагноз: Грыжа межпозвоночного диска L5-S1 (МКБ-10: M51.1)
Параметры: Грыжа 5 мм
Анамнез: Боли в пояснице 6 месяцев

✅ Диагноз ↔ Анамнез:
   Грыжа объясняет боли

❌ Диагноз ↔ Подпункт:
   Для статьи 66 требуются:
   - Размеры спинномозгового канала (НЕТ)
   - Неврологические нарушения (НЕТ)
   - Парезы, проводниковые расстройства (НЕТ)

⚠️ Подпункт ↔ Категория:
   Подпункт не определен → категория не определена

❌ Категория ИИ ↔ Категория врача:
   ИИ: null, Врач: Б (нет оснований для категории)

⚠️ Анамнез ↔ Категория:
   Недостаточно данных о тяжести

Итог: DATA_INSUFFICIENT, риск HIGH
Требуется: МРТ с измерением канала, обследование у невролога
```

## Ключевые правила маппинга

### Миопия (близорукость)

| Диоптрии | Статья | Подпункт | Категория | Примечание |
|----------|--------|----------|-----------|------------|
| До 3.0D | 34 | 5 | А | Годен |
| 3.0-6.0D | 34 | 4 | Б | Годен с ограничениями |
| 6.0-8.0D | 34 | 3 | Д | Не годен |
| 8.0-12.0D | 34 | 2 | Д | Не годен |
| Более 12.0D | 34 | 1 | Е | Не годен |

**Критически важно:** Миопия → ВСЕГДА статья 34, НЕ статья 15!

### Плоскостопие

| Степень | Болевой синдром | Статья | Подпункт | Категория |
|---------|----------------|--------|----------|-----------|
| 1 степень | Отсутствует | 68 | 3 | А |
| 2 степень | Умеренный | 68 | 2 | Б |
| 3 степень | Выраженный | 68 | 1 | Д |

### Артериальная гипертензия

| Степень | Осложнения | Статья | Подпункт | Категория |
|---------|------------|--------|----------|-----------|
| 1 степень | Нет | 42 | 3 | Б |
| 2 степень | Умеренные | 42 | 2 | В |
| 3 степень | Выраженные | 42 | 1 | Д |

### Грыжи дисков

⚠️ **ВНИМАНИЕ:** Нет прямых критериев для "грыж дисков" в Приказе №722!

Требуются данные о:
- Стенозе спинномозгового канала (размеры в мм)
- Грубых неврологических нарушениях (парезы, проводниковые расстройства)
- Операциях (дискэктомии)

Без этих данных: **data_insufficiency = true**

## Уровни confidence (уверенности)

| Диапазон | Значение | Действие |
|----------|----------|----------|
| **> 0.9** | Очень высокая | Категория определена однозначно |
| **0.7-0.9** | Высокая | Категория определена с хорошей уверенностью |
| **0.5-0.7** | Средняя | Требуется проверка председателем ВВК |
| **0.3-0.5** | Низкая | Требуется дополнительное обследование |
| **< 0.3** | Очень низкая | Критическая ошибка или недостаток данных |

## Графики призывников

| График | Категория призывников | Требования |
|--------|----------------------|------------|
| **1** | Призывники рядового состава | Стандартные |
| **2** | Курсанты военных училищ | Повышенные |
| **3** | Офицеры запаса | Средние |
| **4** | Спецназ и спецподразделения | Максимальные |

**Пример:** Статья 34, подпункт 4
- График 1: Категория Б
- График 2: Категория В (более строго)

## Категории годности

| Категория | Расшифровка | Статус |
|-----------|-------------|--------|
| **А** | Годен к военной службе | Призыв без ограничений |
| **Б** | Годен с незначительными ограничениями | Призыв с ограничениями по роду войск |
| **В** | Ограниченно годен | Зачисление в запас (призыв только в военное время) |
| **Г** | Временно не годен | Отсрочка (повторное освидетельствование через 6-12 мес) |
| **Д** | Не годен к военной службе | Полное освобождение от службы |
| **НГ** | Не годен к призыву | - |

## Быстрая диагностика проблем

### Проблема: AI определил неправильную статью

**Причина:** Неправильный маппинг МКБ-10 → Статья
**Решение:** Проверить файл `icd10_to_article_mapper.py`

### Проблема: AI придумал несуществующий подпункт

**Причина:** Валидация не сработала
**Решение:** Проверить `criteria_validator.py` и справочник в БД

### Проблема: Категория не совпадает с ожидаемой

**Причина:** Категория в справочнике неверна
**Решение:** Проверить таблицу `point_diagnoses` в БД

### Проблема: confidence слишком низкий

**Причина:** Недостаток данных или неоднозначность
**Решение:** Добавить больше контекста в RAG или запросить дополнительные данные

### Проблема: data_insufficiency не срабатывает

**Причина:** Логика проверки неполноты данных не настроена
**Решение:** Проверить промпты в `ai_analyzer.py` и добавить правила

## Полезные команды

```bash
# Запуск одного теста
python scripts/test_all_scenarios.py 3

# Запуск всех тестов
python scripts/test_all_scenarios.py

# Запуск теста с отладкой
PYTHONPATH=. python -m pdb scripts/test_all_scenarios.py 7

# Просмотр тестовых данных
cat test_data/doctor_conclusions_examples.json | jq '.test_cases[] | {id: .case_id, name: .name}'
```

## См. также

- [README.md](README.md) - Подробная документация
- [USAGE.md](USAGE.md) - Инструкция по использованию
- [doctor_conclusions_examples.json](doctor_conclusions_examples.json) - Тестовые данные
