# Диаграмма логики проверок системы ВВК

## Общая схема процесса

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│                        ЗАКЛЮЧЕНИЕ ВРАЧА-СПЕЦИАЛИСТА                         │
│                                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   Диагноз    │  │   Анамнез    │  │ Объективные │  │  Категория   │  │
│  │   МКБ-10     │  │              │  │    данные    │  │    врача     │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ЭТАП 1: AI АНАЛИЗ ЗАКЛЮЧЕНИЯ                             │
│                                                                             │
│  Вход: doctor_conclusion, icd10_codes, specialty, anamnesis                │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  1.1 Проверка на "здорового призывника"                            │  │
│  │      - Ключевые слова: "практически здоров", "патологии не выявлено"│ │
│  │      - Если здоров → article: null, subpoint: null, category: А     │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  1.2 Маппинг МКБ-10 → Статья Приказа                               │  │
│  │      - Использует icd10_to_article_mapper                           │  │
│  │      - Пример: H52.1 (Миопия) → Статья 34                          │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  1.3 RAG: Поиск релевантных критериев                              │  │
│  │      - Формирует контекст из базы знаний                            │  │
│  │      - Добавляет критерии подпунктов для статьи                     │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  1.4 AI определяет подпункт                                         │  │
│  │      - Анализирует параметры (степень, стадия, размеры)             │  │
│  │      - Сравнивает с критериями из контекста                         │  │
│  │      - Возвращает: article, subpoint, confidence, reasoning         │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  Выход: {article: 34, subpoint: "4", confidence: 0.92, ...}                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                  ЭТАП 2: ВАЛИДАЦИЯ ПОДПУНКТА                                │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  2.1 Проверка существования подпункта в справочнике                 │  │
│  │      - criteria_validator.validate_article_subpoint()               │  │
│  │      - Проверяет таблицу point_criteria в БД                        │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│                    ┌──────────────────┐                                    │
│                    │  Подпункт есть?  │                                    │
│                    └────────┬─────────┘                                    │
│                             │                                              │
│                   ┌─────────┴─────────┐                                    │
│                   │                   │                                    │
│                  ДА                  НЕТ                                   │
│                   │                   │                                    │
│                   ▼                   ▼                                    │
│         ┌─────────────────┐   ┌──────────────────┐                        │
│         │  validated: true │   │ confidence < 0.3 │                        │
│         │  Продолжаем     │   │ validation_error │                        │
│         └─────────────────┘   └──────────────────┘                        │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  2.2 Проверка полноты данных                                        │  │
│  │      - Все параметры указаны?                                        │  │
│  │      - Если нет → data_insufficiency: true                          │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│               ЭТАП 3: ОПРЕДЕЛЕНИЕ КАТЕГОРИИ ГОДНОСТИ                        │
│                                                                             │
│  Вход: article, subpoint, graph                                             │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  3.1 Запрос категории из справочника (НЕ от AI!)                   │  │
│  │      - Таблица point_diagnoses в БД                                 │  │
│  │      - SELECT category FROM point_diagnoses                         │  │
│  │        WHERE article = ? AND subpoint = ? AND graph = ?             │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  3.2 Возврат категории                                              │  │
│  │      - category: "Б"                                                │  │
│  │      - confidence: 1.0 (из справочника!)                            │  │
│  │      - source: "HANDBOOK"                                           │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  Выход: {category: "Б", confidence: 1.0, source: "HANDBOOK", ...}          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│               ЭТАП 4: СРАВНЕНИЕ С КАТЕГОРИЕЙ ВРАЧА                          │
│                                                                             │
│  Вход: ai_category (из справочника), doctor_category                        │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  4.1 Сравнение категорий                                            │  │
│  │      ai_category == doctor_category ?                               │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│                    ┌──────────────────┐                                    │
│                    │  Категории равны?│                                    │
│                    └────────┬─────────┘                                    │
│                             │                                              │
│                   ┌─────────┴─────────┐                                    │
│                   │                   │                                    │
│                  ДА                  НЕТ                                   │
│                   │                   │                                    │
│                   ▼                   ▼                                    │
│         ┌─────────────────┐   ┌──────────────────┐                        │
│         │  status: MATCH  │   │ status: MISMATCH │                        │
│         │  risk: LOW      │   │ risk: HIGH       │                        │
│         └─────────────────┘   └──────────────────┘                        │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  4.2 Расчет уровня риска                                            │  │
│  │      - HIGH: несовпадение категорий ИЛИ confidence < 0.5            │  │
│  │      - MEDIUM: confidence 0.5-0.7                                   │  │
│  │      - LOW: совпадение И confidence > 0.7                           │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  Выход: {status: "MATCH", risk_level: "LOW", ...}                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      ИТОГОВЫЙ РЕЗУЛЬТАТ                                     │
│                                                                             │
│  {                                                                          │
│    "specialty": "Офтальмолог",                                             │
│    "doctor_category": "Б",                                                 │
│    "ai_recommended_category": "Б",                                         │
│    "status": "MATCH",                                                      │
│    "risk_level": "LOW",                                                    │
│    "article": 34,                                                          │
│    "subpoint": "4",                                                        │
│    "confidence": 0.92,                                                     │
│    "reasoning": "Миопия 3.0-6.0D → Статья 34, подпункт 4 → Категория Б"  │
│  }                                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Детализация проверок

### Проверка 1: Диагноз ↔ Анамнез

```
┌─────────────────┐        ┌─────────────────┐
│     Диагноз     │        │     Анамнез     │
│                 │        │                 │
│  "Миопия 4.5D"  │◄──────►│  "Носит очки   │
│                 │        │   с 12 лет"     │
└─────────────────┘        └─────────────────┘
         │                          │
         └──────────┬───────────────┘
                    ▼
           ┌─────────────────┐
           │  Проверка:      │
           │  - Согласованы? │
           │  - Подтверждают?│
           └─────────────────┘
                    │
         ┌──────────┴──────────┐
         │                     │
        ДА                    НЕТ
         │                     │
         ▼                     ▼
    ┌────────┐           ┌────────┐
    │   ✅   │           │   ❌   │
    └────────┘           └────────┘
```

### Проверка 2: Диагноз ↔ Подпункт

```
┌──────────────────────────┐
│  Диагноз + Параметры     │
│                          │
│  МКБ-10: H52.1           │
│  Параметры: 4.5D         │
└────────────┬─────────────┘
             │
             ▼
┌──────────────────────────┐
│  Маппинг МКБ-10 → Статья │
│  H52.1 → Статья 34       │
└────────────┬─────────────┘
             │
             ▼
┌──────────────────────────┐
│  Критерии подпунктов:    │
│  - Подп. 5: до 3.0D      │
│  - Подп. 4: 3.0-6.0D ✓   │◄─── 4.5D подходит
│  - Подп. 3: 6.0-8.0D     │
└────────────┬─────────────┘
             │
             ▼
┌──────────────────────────┐
│  Результат:              │
│  Статья 34, подпункт 4   │
└──────────────────────────┘
```

### Проверка 3: Подпункт ↔ Категория

```
┌──────────────────────────┐
│  Статья 34, подпункт 4   │
│  График 1 (призывник)    │
└────────────┬─────────────┘
             │
             ▼
┌──────────────────────────┐
│  Запрос в справочник:    │
│  SELECT category         │
│  FROM point_diagnoses    │
│  WHERE article=34        │
│    AND subpoint="4"      │
│    AND graph=1           │
└────────────┬─────────────┘
             │
             ▼
┌──────────────────────────┐
│  Категория: Б            │
│  (ИЗ СПРАВОЧНИКА!)       │
└──────────────────────────┘
```

### Проверка 4: Категория ИИ ↔ Категория врача

```
┌─────────────────┐        ┌─────────────────┐
│  Категория ИИ   │        │ Категория врача │
│  (справочник)   │        │                 │
│       Б         │        │       Б         │
└────────┬────────┘        └────────┬────────┘
         │                          │
         └──────────┬───────────────┘
                    ▼
              ┌─────────┐
              │   Б=Б?  │
              └────┬────┘
                   │
                  ДА
                   │
                   ▼
         ┌─────────────────┐
         │  status: MATCH  │
         │  risk_level: LOW│
         └─────────────────┘
```

### Проверка 5: Анамнез ↔ Категория

```
┌──────────────────────────┐
│       Анамнез            │
│                          │
│  "Стабильное течение,    │
│   без осложнений"        │
└────────────┬─────────────┘
             │
             ▼
┌──────────────────────────┐
│  Оценка тяжести:         │
│  - Легкое течение        │
│  - Без осложнений        │
│  - Стабильное            │
└────────────┬─────────────┘
             │
             ▼
┌──────────────────────────┐
│  Категория Б соответствует│
│  легкому/среднему течению│
└──────────────────────────┘
             │
             ▼
         ┌───────┐
         │  ✅   │
         └───────┘
```

## Особые сценарии

### Сценарий: Здоровый призывник

```
Заключение: "Практически здоров"
         │
         ▼
┌─────────────────┐
│ Проверка        │
│ ключевых слов   │
└────────┬────────┘
         │
         ▼
    "здоров" найдено
         │
         ▼
┌─────────────────┐
│ article: null   │
│ subpoint: null  │
│ category: А     │
│ is_healthy: true│
└─────────────────┘
```

### Сценарий: Недостаточно данных

```
Заключение: "Грыжа диска L5-S1"
         │
         ▼
┌─────────────────┐
│ Проверка        │
│ параметров      │
└────────┬────────┘
         │
         ▼
    Отсутствуют:
    - Размер канала
    - Неврологические нарушения
         │
         ▼
┌──────────────────────────┐
│ data_insufficiency: true │
│ confidence < 0.5         │
│ missing_parameters: [...] │
└──────────────────────────┘
```

### Сценарий: Ошибка врача

```
Параметры: 4.5D миопия
         │
         ▼
┌─────────────────┐
│ AI анализ       │
└────────┬────────┘
         │
         ▼
    Статья 34, подп. 4
         │
         ▼
┌─────────────────┐
│ Справочник:     │
│ Категория Б     │
└────────┬────────┘
         │
         ▼
    Врач поставил: А
         │
         ▼
┌─────────────────┐
│ Б ≠ А           │
│ status: MISMATCH│
│ risk_level: HIGH│
└─────────────────┘
```

## Логическая схема уровней риска

```
                 ┌────────────────┐
                 │ Начало оценки  │
                 └───────┬────────┘
                         │
              ┌──────────▼──────────┐
              │ Категории совпадают?│
              └──────────┬──────────┘
                         │
                  ┌──────┴──────┐
                  │             │
                 ДА            НЕТ
                  │             │
                  │             ▼
                  │      ┌──────────┐
                  │      │ RISK:    │
                  │      │ HIGH     │
                  │      └──────────┘
                  │
                  ▼
         ┌────────────────┐
         │ Confidence > 0.7?│
         └────────┬───────┘
                  │
           ┌──────┴──────┐
           │             │
          ДА            НЕТ
           │             │
           ▼             ▼
    ┌──────────┐  ┌──────────────┐
    │ RISK:    │  │ Confidence   │
    │ LOW      │  │ > 0.5?       │
    └──────────┘  └──────┬───────┘
                          │
                   ┌──────┴──────┐
                   │             │
                  ДА            НЕТ
                   │             │
                   ▼             ▼
            ┌──────────┐  ┌──────────┐
            │ RISK:    │  │ RISK:    │
            │ MEDIUM   │  │ HIGH     │
            └──────────┘  └──────────┘
```

## Итоговая логика в коде

```python
# Псевдокод логики проверок

def analyze_examination(doctor_conclusion, icd10_codes, doctor_category):
    # 1. Определение подпункта
    if is_healthy(doctor_conclusion):
        return {category: "А", article: null, subpoint: null}

    article = map_icd10_to_article(icd10_codes[0])
    subpoint = ai_determine_subpoint(doctor_conclusion, article)

    # 2. Валидация подпункта
    if not validate_subpoint(article, subpoint):
        return {error: "Invalid subpoint", confidence: 0.3}

    # 3. Определение категории ИЗ СПРАВОЧНИКА
    ai_category = get_category_from_handbook(article, subpoint, graph=1)

    # 4. Сравнение с категорией врача
    if ai_category == doctor_category:
        status = "MATCH"
        risk = "LOW"
    else:
        status = "MISMATCH"
        risk = "HIGH"

    return {
        article, subpoint,
        ai_category, doctor_category,
        status, risk
    }
```
