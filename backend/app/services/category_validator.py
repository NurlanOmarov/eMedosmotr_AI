"""
Валидатор категорий годности для статей Приказа 722
Проверяет допустимость комбинации (статья, категория)
"""

from typing import Optional, Dict, Set, List
import logging

logger = logging.getLogger(__name__)


class CategoryValidator:
    """
    Валидатор категорий для статей Приказа 722

    Проверяет, допустима ли категория для данной статьи по графу I
    """

    # Маппинг: статья → множество допустимых категорий для графа I
    # Основано на анализе points_diagnoses таблицы
    VALID_CATEGORIES_BY_ARTICLE: Dict[int, Set[str]] = {
        # Психические расстройства
        15: {'Е', 'Д'},  # Шизофрения, биполярное расстройство
        16: {'Е', 'Д', 'Г', 'Б'},  # Органические психические расстройства (F00-F09)
        17: {'Д', 'Б'},  # Невротические расстройства (F40-F48, F50-F59)
        18: {'Е', 'Д'},  # Расстройства личности (F60-F69) - НЕТ категории В!
        19: {'Е', 'Д'},  # Зависимости (F10-F19)
        20: {'Е', 'Д'},  # Умственная отсталость (F70-F79)

        # Нервная система
        21: {'Е', 'Д', 'Б'},  # Эпилепсия, мигрень
        22: {'Е', 'Д', 'Г', 'Б'},  # Инфекционные болезни нервной системы
        23: {'Е', 'Д', 'Б'},  # Экстрапирамидные болезни, ДЦП

        # Глаза
        30: {'Е', 'Д', 'В', 'Б'},  # Катаракта, болезни хрусталика
        31: {'Е', 'Д', 'Б'},  # Дистрофии сетчатки
        32: {'Е', 'Д', 'Б'},  # Глаукома
        33: {'Е', 'Д'},  # Атрофия зрительного нерва
        34: {'Е', 'Д', 'Б'},  # Нарушения рефракции (миопия)
        35: {'Е', 'Д', 'В', 'Б'},  # Расстройства зрения

        # Уши
        37: {'Д', 'В', 'Б'},  # Болезни наружного уха
        38: {'Е', 'Д', 'В', 'Б'},  # Болезни среднего уха
        39: {'Д', 'В', 'Б'},  # Вестибулярные расстройства
        40: {'Е', 'Д', 'В', 'Б'},  # Тугоухость

        # Сердечно-сосудистая система
        42: {'Е', 'Д', 'В', 'Б'},  # Болезни клапанов сердца
        43: {'Е', 'Д', 'В', 'Б'},  # Гипертоническая болезнь
        44: {'Е', 'Д', 'В', 'Б'},  # ИБС
        45: {'Е', 'Д', 'В', 'Б'},  # Болезни вен

        # Органы дыхания
        48: {'Д', 'В', 'Б'},  # Болезни носа, околоносовых пазух
        49: {'Д', 'В', 'Б'},  # Болезни глотки, гортани
        50: {'Е', 'Д', 'В', 'Б'},  # ХОБЛ
        51: {'Е', 'Д', 'В', 'Б'},  # Астма

        # Органы пищеварения
        57: {'Е', 'Д', 'В', 'Б'},  # Язвенная болезнь
        58: {'Е', 'Д', 'В', 'Б'},  # Гастрит, дуоденит, болезни печени
        59: {'Е', 'Д', 'В', 'Б'},  # Грыжи брюшной полости
        60: {'Д', 'В', 'Б'},  # Геморрой

        # Кожа
        62: {'Е', 'Д', 'Б'},  # Болезни кожи (атопический дерматит, псориаз)

        # Костно-мышечная система
        65: {'Е', 'Д', 'В', 'Б'},  # Артриты
        66: {'Е', 'Д', 'В', 'Б'},  # Болезни позвоночника
        68: {'Е', 'Д', 'В', 'Б'},  # Плоскостопие, деформации стопы

        # Мочеполовая система
        71: {'Е', 'Д', 'В', 'Б'},  # Болезни почек
        72: {'Е', 'Д', 'В', 'Б'},  # Мочекаменная болезнь
        73: {'Е', 'Д', 'В', 'Б'},  # Болезни мужских половых органов

        # Энурез
        88: {'Д', 'В'},  # Энурез
    }

    # Особые случаи: статьи, где категория В недопустима
    ARTICLES_WITHOUT_B_CATEGORY = {18, 20, 23, 31, 32, 33, 34, 62}

    # Особые случаи: статьи, где только Е и Д
    ARTICLES_E_D_ONLY = {18, 19, 20, 33}

    @classmethod
    def is_category_valid(cls, article: int, category: str, graph: int = 1) -> bool:
        """
        Проверяет, допустима ли категория для данной статьи

        Args:
            article: Номер статьи Приказа 722
            category: Категория годности (А, Б, В, Г, Д, Е)
            graph: График (1, 2, 3) - пока поддерживается только граф 1

        Returns:
            True если категория допустима, False иначе
        """
        if graph != 1:
            logger.warning(f"Валидация категорий для графа {graph} пока не поддерживается")
            return True  # Пропускаем для других графов

        # Категория А всегда означает "здоров" - не привязана к статьям
        if category == 'А':
            return True

        # Если статьи нет в маппинге - разрешаем (неизвестная статья)
        if article not in cls.VALID_CATEGORIES_BY_ARTICLE:
            logger.warning(f"Статья {article} не найдена в маппинге допустимых категорий")
            return True

        valid_categories = cls.VALID_CATEGORIES_BY_ARTICLE[article]
        is_valid = category in valid_categories

        if not is_valid:
            logger.warning(
                f"Недопустимая категория {category} для статьи {article}. "
                f"Допустимые категории: {', '.join(sorted(valid_categories))}"
            )

        return is_valid

    @classmethod
    def get_valid_categories(cls, article: int, graph: int = 1) -> List[str]:
        """
        Возвращает список допустимых категорий для статьи

        Args:
            article: Номер статьи
            graph: График (по умолчанию 1)

        Returns:
            Список допустимых категорий
        """
        if article not in cls.VALID_CATEGORIES_BY_ARTICLE:
            return []

        return sorted(cls.VALID_CATEGORIES_BY_ARTICLE[article])

    @classmethod
    def suggest_alternative_category(cls, article: int, invalid_category: str, graph: int = 1) -> Optional[str]:
        """
        Предлагает альтернативную категорию, если текущая недопустима

        Args:
            article: Номер статьи
            invalid_category: Недопустимая категория
            graph: График

        Returns:
            Предлагаемая категория или None
        """
        valid_categories = cls.get_valid_categories(article, graph)

        if not valid_categories:
            return None

        # Маппинг категорий по тяжести: А < Б < В < Г < Д < Е
        category_severity = {'А': 0, 'Б': 1, 'В': 2, 'Г': 3, 'Д': 4, 'Е': 5}
        invalid_severity = category_severity.get(invalid_category, 0)

        # Ищем ближайшую более тяжелую категорию
        for cat in ['Б', 'В', 'Г', 'Д', 'Е']:
            if cat in valid_categories and category_severity[cat] >= invalid_severity:
                return cat

        # Если не нашли, возвращаем самую мягкую из допустимых
        for cat in ['Б', 'В', 'Г', 'Д', 'Е']:
            if cat in valid_categories:
                return cat

        return None


# Глобальный экземпляр
category_validator = CategoryValidator()
