"""
AI сервис для анализа медицинских заключений
Определение подпунктов и категорий годности
"""

from typing import Dict, Any, Optional, List
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
import json
import logging
from datetime import datetime

from app.models.reference import PointDiagnosis, PointCriterion
from app.models.ai import AIAnalysisResult
# from app.models.ai import AIRequestLog  # Закомментировано - класс не существует
from app.services.openai_client import openai_service
from app.services.rag_service import rag_service
from app.services.criteria_validator import criteria_validator, CriteriaValidationResult
from app.services.icd10_to_article_mapper import icd10_mapper
from app.services.category_validator import category_validator
from app.config import settings

logger = logging.getLogger(__name__)


class AIAnalyzer:
    """
    AI анализатор медицинских заключений
    """

    # Ключевые слова для определения здорового призывника
    HEALTHY_KEYWORDS = [
        "практически здоров",
        "патологии не выявлено",
        "патологий не выявлено",
        "отсутствие жалоб",
        "жалоб нет",
        "нормальное развитие",
        "нормальное физическое развитие",
        "здоров",
        "без патологий",
        "без патологии",
        "не выявлено патологии",
        "патология не обнаружена",
        "без отклонений",
        "в норме"
    ]

    # Исключающие слова (если есть эти слова БЕЗ отрицания, то НЕ здоров)
    PATHOLOGY_KEYWORDS = [
        "выявлена",
        "выявлено",
        "обнаружена",
        "обнаружено",
        "диагностирован",
        "установлен диагноз",
        "имеется заболевание",
        "имеется нарушение",
        "имеется деформация",
        "снижена",
        "снижено",
        "повышена",
        "повышено",
        "ограничена",
        "ограничено"
    ]

    # Тяжелые заболевания, несовместимые с категорией "А"
    SEVERE_CONDITIONS_KEYWORDS = [
        "туберкулез",
        "туберкулёз",
        "шизофрения",
        "эпилепсия",
        "слепота",
        "глухота",
        "вич",
        "спид",
        "гепатит с",
        "гепатит b",
        "инвалидность",
        "инвалид",
        "ампутация",
        "паралич",
        "парез",
        "злокачественн",
        "онкологи",
        "рак ",
        "саркома",
        "лейкоз",
        "психоз",
        "умственная отсталость",
        "олигофрения",
        "деменция",
        "наркоман",
        "алкоголизм",
        "цирроз",
        "почечная недостаточность",
        "сердечная недостаточность",
        "диабет 1 типа",
        "сахарный диабет 1"
    ]

    @classmethod
    def get_healthy_keywords(cls) -> list:
        """
        Получить список ключевых слов здорового статуса

        Используется в contradiction_checker для проверки противоречий
        """
        return cls.HEALTHY_KEYWORDS.copy()

    @classmethod
    def get_pathology_keywords(cls) -> list:
        """
        Получить список ключевых слов патологий

        Используется в contradiction_checker для проверки противоречий
        """
        return cls.PATHOLOGY_KEYWORDS.copy()

    @classmethod
    def get_severe_conditions_keywords(cls) -> list:
        """
        Получить список ключевых слов тяжелых заболеваний

        Используется для проверки TYPE_F противоречий
        (тяжелый диагноз + категория "А")
        """
        return cls.SEVERE_CONDITIONS_KEYWORDS.copy()

    # Промпт для AI-проверки здоровья призывника (для неопределённых случаев)
    HEALTH_STATUS_CHECK_PROMPT = """Ты - эксперт по военно-врачебной экспертизе.
Твоя задача - определить, является ли призывник ЗДОРОВЫМ (годен к категории А без ограничений).

КРИТЕРИИ ЗДОРОВОГО ПРИЗЫВНИКА:
1. ✅ Нет текущих активных заболеваний, требующих лечения или наблюдения
2. ✅ Нет хронических заболеваний в стадии обострения или ремиссии
3. ✅ Функциональные показатели в норме
4. ✅ Вылеченные заболевания БЕЗ остаточных явлений и последствий (например: санированная полость рта, зажившие переломы без деформаций)

КРИТЕРИИ БОЛЬНОГО ПРИЗЫВНИКА:
1. ❌ Есть активное заболевание (даже в лёгкой форме)
2. ❌ Хроническое заболевание в анамнезе (даже в ремиссии)
3. ❌ Функциональные нарушения (даже незначительные)
4. ❌ Вылеченное заболевание С остаточными явлениями (например: деформации, рубцы, ограничения функции)

ВАЖНЫЕ ПРИМЕРЫ:

✅ ЗДОРОВ:
- "Патологии не выявлено"
- "Призывник здоров"
- "Кариес вылечен, полость рта санирована" (если нет пародонтита/пародонтоза)
- "Перелом зажил без деформации и ограничения функции"

❌ БОЛЕН:
- "Кариес" (без указания на лечение)
- "Плоскостопие 1 степени" (даже лёгкая степень - это патология)
- "Хронический гастрит вне обострения" (хроническое заболевание)
- "Близорукость слабой степени" (нарушение зрения)
- "Перелом зажил с деформацией" (есть остаточные явления)

Проанализируй заключение врача и верни JSON:
{{
  "is_healthy": true/false,
  "confidence": 0.0-1.0,
  "reasoning": "Подробное объяснение почему призывник здоров или болен"
}}"""

    # Промпт для определения подпункта
    SUBPOINT_DETERMINATION_PROMPT = """Ты - эксперт по военно-врачебной экспертизе Республики Казахстан.
Твоя задача - проанализировать медицинское заключение врача-специалиста и определить подпункт статьи по Приказу МО РК №722.

⚠️⚠️⚠️ КРИТИЧЕСКИ ВАЖНО - ПЕРВИЧНАЯ ПРОВЕРКА ПЕРЕД ОПРЕДЕЛЕНИЕМ СТАТЬИ:

ШАГЛЮБОЙ №1: ОБЯЗАТЕЛЬНАЯ ПРОВЕРКА НА ВЕГЕТО-СОСУДИСТУЮ ДИСТОНИЮ (ВСД):

ЕСЛИ код МКБ-10 = G90.x (G90.0, G90.8, G90.9 и т.д.) ИЛИ в диагнозе упоминается "вегето-сосудистая дистония", "НЦД", "вегетативная дисфункция", "вегетативная дистония":

ТО выполни следующие проверки:

1. Проверь наличие ДОКУМЕНТИРОВАННЫХ ОБМОРОКОВ (синкопальных состояний):
   - Ищи в анамнезе/заключении фразы: "обмороки", "синкопальные состояния", "потеря сознания"
   - ВАЖНО: "тахикардия", "сердцебиение", "головокружение" - это НЕ обмороки!

2. ЕСЛИ обмороков НЕТ:
   - article: null
   - subpoint: null
   - confidence: 0.95
   - reasoning: "Диагноз G90.x - Вегето-сосудистая дистония является функциональным расстройством вегетативной нервной системы и НЕ относится к статье 24 (болезни сосудов головного и спинного мозга). В заключении отсутствуют документированные обмороки (синкопальные состояния). При ВСД без органических изменений и обмороков призывник получает категорию А (годен к военной службе)."
   - is_healthy: false (т.к. есть диагноз, но он не препятствует службе)
   - НЕ применяй статью 24!

3. ЕСЛИ есть ДОКУМЕНТИРОВАННЫЕ обмороки:
   - Применяй статью 24, подпункт 4 (редкие обмороки ≤2/год) → Категория Б
   - ИЛИ подпункт 3 (частые обмороки ≥3/год) → Категория Д

⚠️ ЗАПРЕЩЕНО применять статью 24 к ВСД (G90.x) БЕЗ документированных обмороков!

⚠️ СПЕЦИАЛЬНОЕ ПРАВИЛО ДЛЯ ЗДОРОВЫХ ПРИЗЫВНИКОВ:
Если в заключении врача указано, что призывник ЗДОРОВ и патологий НЕ ВЫЯВЛЕНО (например: "практически здоров", "патологии не выявлено", "отсутствие жалоб и нормальное развитие", "без патологий"), то:
- article: null
- subpoint: null
- confidence: 1.0
- reasoning: "Призывник здоров, патологии не выявлены. Согласно Приказу №722, при отсутствии патологий призывник получает категорию А (годен к военной службе) без указания статьи расписания болезней."
- is_healthy: true

⚠️⚠️⚠️ УНИВЕРСАЛЬНЫЕ ПРАВИЛА АНАЛИЗА ЗАКЛЮЧЕНИЙ:

ПРАВИЛО №0: ПРИОРИТЕТ ЧАСТЕЙ ЗАКЛЮЧЕНИЯ ПРИ ПРОТИВОРЕЧИЯХ

При анализе медицинского заключения используй следующий ПРИОРИТЕТ информации:

1. **ЗАКЛЮЧЕНИЕ** (conclusion_text) - **НАИВЫСШИЙ приоритет**
   - Это итоговое мнение врача
   - Содержит финальный диагноз и выводы
   - ПРИ ПРОТИВОРЕЧИЯХ: используй данные отсюда!

2. **ОБЪЕКТИВНЫЕ ДАННЫЕ** (objective_data) - **ВЫСОКИЙ приоритет**
   - Результаты осмотра врача
   - Измеримые параметры (АД, ЧСС, рост, вес и т.д.)

3. **РЕЗУЛЬТАТЫ ИССЛЕДОВАНИЙ** (special_research_results) - **ВЫСОКИЙ приоритет**
   - Лабораторные анализы
   - Инструментальные исследования (УЗИ, рентген, ФГДС и т.д.)

4. **АНАМНЕЗ** (anamnesis) - **НИЗКИЙ приоритет**
   - Слова пациента о истории болезни
   - Может содержать ошибки памяти или неточности

⚠️ **КРИТИЧЕСКИ ВАЖНО ПРИ ПРОТИВОРЕЧИЯХ:**

Если анамнез ПРОТИВОРЕЧИТ заключению или объективным данным:
→ **ИГНОРИРУЙ анамнез**
→ **ИСПОЛЬЗУЙ данные из заключения**
→ **Отдавай приоритет объективным фактам**

**ПРИМЕРЫ ПРОТИВОРЕЧИЙ:**

❌ НЕПРАВИЛЬНО:
```
Анамнез: "Операций на венах никогда не было"
Заключение: "Состояние после флебэктомии справа"
→ AI ошибается: "операций не было"
```

✅ ПРАВИЛЬНО:
```
Анамнез: "Операций на венах никогда не было"  ← ИГНОРИРУЙ это!
Заключение: "Состояние после флебэктомии справа"  ← ИСПОЛЬЗУЙ это!
→ AI определяет: "Перенесена флебэктомия" → Статья 45, подпункт 4
```

❌ НЕПРАВИЛЬНО:
```
Анамнез: "Не болел туберкулезом"
Результаты: "Флюорография: очаговые тени в верхней доле"
→ AI ошибается: "не болел"
```

✅ ПРАВИЛЬНО:
```
Анамнез: "Не болел туберкулезом"  ← ИГНОРИРУЙ!
Результаты: "Флюорография: очаговые тени"  ← ИСПОЛЬЗУЙ!
→ AI определяет: подозрение на туберкулез
```

**ПРАВИЛО ДЛЯ КОД МКБ-10:**

Код МКБ-10 имеет **НАИВЫСШИЙ приоритет** для определения статьи!

Если код МКБ-10 = I83.x (варикозная болезнь):
→ ОБЯЗАТЕЛЬНО используй статью 45 (болезни вен)
→ НЕЛЬЗЯ использовать статью 83 (травмы органов)

Если код МКБ-10 = F20.x (шизофрения):
→ ОБЯЗАТЕЛЬНО используй статью 15 (психические расстройства)
→ НЕЛЬЗЯ игнорировать тяжесть диагноза

**КЛЮЧЕВЫЕ СЛОВА - МАРКЕРЫ ОПЕРАЦИЙ:**

Если в заключении есть слова, указывающие на **ПЕРЕНЕСЁННЫЕ ОПЕРАЦИИ**, используй их для определения статьи:

Операции на венах → Статья 45:
- "флебэктомия" → подпункт 4, категория Б
- "склерозирование вен" → подпункт 4, категория Б
- "иссечение варикозных вен" → подпункт 4, категория Б
- "операция на венах" → подпункт 4, категория Б
- "состояние после венозной операции" → подпункт 4, категория Б

Операции на сердце → Статья 42:
- "АКШ" (аортокоронарное шунтирование)
- "стентирование коронарных артерий"
- "имплантация кардиостимулятора"

Операции на ЖКТ → Статьи 56-60:
- "резекция желудка"
- "холецистэктомия" (удаление желчного пузыря)
- "гастрэктомия"

⚠️ **ВАЖНО:** Наличие операции в заключении **ВСЕГДА** важнее, чем слова пациента в анамнезе!

---

⚠️ КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА МАППИНГА ДИАГНОЗОВ:
1. МИОПИЯ, БЛИЗОРУКОСТЬ (указаны диоптрии) → ВСЕГДА статья 34 "Нарушения рефракции", НЕ статья 15!

   ВАЖНО: В базе данных для статьи 34 есть ТОЛЬКО 4 подпункта (1, 2, 3, 4). Подпункта 5 НЕ существует!

   Маппинг степеней близорукости на подпункты:
   - Близорукость слабой/средней степени (до 6.0 диоптрий) → Статья 34, подпункт 4 → Категория Б
     Примеры: -2.0D, -3.5D, -5.0D
   - Близорукость высокой степени (от 6.0 до 8.0 диоптрий) → Статья 34, подпункт 3 → Категория Д
     Примеры: -6.5D, -7.5D
   - Близорукость очень высокой степени (от 8.0 до 12.0 диоптрий) → Статья 34, подпункт 2 → Категория Д
     Примеры: -9.0D, -11.0D
   - Близорукость экстремально высокой степени (более 12.0 диоптрий) → Статья 34, подпункт 1 → Категория Е
     Примеры: -13.0D, -15.0D и выше

   ⚠️ ВАЖНО: Даже слабая близорукость (-2.0D) НЕ даёт категорию А! Минимум - категория Б (подпункт 4).

   ⚠️⚠️ КРИТИЧЕСКИ ВАЖНО ДЛЯ МИОПИИ - ОСТРОТА ЗРЕНИЯ:

   Призывник с МИОПИЕЙ (близорукостью) НЕ МОЖЕТ получить категорию А, даже если острота зрения 1.0!

   ПОЧЕМУ: Острота зрения при миопии ВСЕГДА указывается "С КОРРЕКЦИЕЙ" (в очках/линзах).

   Ключевые маркеры в заключении офтальмолога:
   - "OD sph -4.5D = 1.0" означает: зрение 1.0 достигается ТОЛЬКО с линзой -4.5D (в очках)
   - "Острота зрения С КОРРЕКЦИЕЙ: OD 1.0, OS 1.0" - зрение хорошее ТОЛЬКО В ОЧКАХ
   - "Острота зрения БЕЗ коррекции: OD 0.1, OS 0.15" - реальное зрение БЕЗ очков (практически слепой!)
   - "Носит очки постоянно" - призывник зависит от коррекции

   ПРАВИЛО ОПРЕДЕЛЕНИЯ КАТЕГОРИИ ПРИ МИОПИИ:

   1. Если указана СТЕПЕНЬ МИОПИИ в диоптриях - используй её для определения подпункта:
      - До 6.0D → Подпункт 4 → Категория Б
      - 6.0-8.0D → Подпункт 3 → Категория Д
      - 8.0-12.0D → Подпункт 2 → Категория Д
      - Более 12.0D → Подпункт 1 → Категория Е

   2. НЕ СМОТРИ на остроту зрения С КОРРЕКЦИЕЙ для определения подпункта!
      Острота зрения с коррекцией может быть 1.0, но это НЕ означает "здоров"!

   3. Острота зрения БЕЗ коррекции и С КОРРЕКЦИЕЙ используется ТОЛЬКО для уточнения:
      - Если острота С КОРРЕКЦИЕЙ < 0.5 на лучшем глазу → может быть более тяжелый подпункт
      - Но основной критерий - СТЕПЕНЬ МИОПИИ В ДИОПТРИЯХ!

   4. Дополнительные факторы, ухудшающие категорию:
      - Дистрофические изменения сетчатки
      - Разрыв сетчатки (в анамнезе или текущий)
      - Лазерная коагуляция сетчатки
      - Осложненная миопия
      → Эти факторы могут повысить подпункт с 4 на 3, или с 3 на 2

   ПРИМЕРЫ:
   ✅ "Миопия средней степени: OD -4.5D = 1.0, OS -4.0D = 1.0. Без коррекции: 0.1 и 0.15"
      → Статья 34, подпункт 4, категория Б (миопия 3-6D, зрение с коррекцией хорошее, но БЕЗ очков слепой)

   ✅ "Миопия высокой степени: OD -12.0D, OS -11.5D. С коррекцией OD 0.5, OS 0.6. Дистрофия сетчатки."
      → Статья 34, подпункт 2, категория Д (миопия >8D + осложнения)

   ❌ ОШИБКА: "Миопия -4.5D, острота зрения 1.0 → здоров → категория А"
      НЕПРАВИЛЬНО! Острота 1.0 ТОЛЬКО В ОЧКАХ! Категория Б!

2. ПЛОСКОСТОПИЕ (плоская стопа, продольное/поперечное плоскостопие) → ВСЕГДА статья 68 "Деформация стопы и другие приобретенные ее деформации"

   ⚠️⚠️ КРИТИЧЕСКИ ВАЖНО - ПОНИМАНИЕ ПОДПУНКТА 1 (КАТЕГОРИЯ Е):

   Подпункт 1 (категория Е) по статье 68 - это НЕ плоскостопие с артрозом!
   Это КРИТИЧЕСКИ ТЯЖЕЛЫЕ ДЕФОРМАЦИИ:
   - ОТСУТСТВИЕ ПАЛЬЦЕВ или ЧАСТИ СТОПЫ (ампутация, потеря на любом уровне)
   - СТОЙКАЯ КОМБИНИРОВАННАЯ КОНТРАКТУРА ВСЕХ ПАЛЬЦЕВ НА ОБЕИХ СТОПАХ (когтистая/молоточкообразная)
   - КРАЙНЕ ТЯЖЕЛЫЕ посттравматические деформации с выраженным нарушением функции

   ⚠️ ПРАВИЛО: Если у призывника ВСЕ пальцы на месте и нет тяжелейших контрактур - это НЕ категория Е!
   Плоскостопие III степени с болевым синдромом - это максимум категория Д (подпункт 2 или 3), но НЕ Е!

   КРИТИЧЕСКИ ВАЖНЫЕ ПАРАМЕТРЫ ДЛЯ КЛАССИФИКАЦИИ:

   А) СТЕПЕНЬ ПЛОСКОСТОПИЯ (обязательный параметр!):
      - I степень: угол свода 131-140°, высота свода 35-25 мм
      - II степень: угол свода 141-155°, высота свода 24-17 мм
      - III степень: угол свода >155°, высота свода <17 мм

   Б) НАЛИЧИЕ АРТРОЗА (деформирующий артроз суставов стопы):
      - АРТРОЗА НЕТ: если в заключении НЕ упомянут артроз/остеоартроз/дегенеративные изменения суставов
      - I стадия: начальные изменения, незначительное сужение суставной щели
      - II стадия: выраженное сужение щели, остеофиты, субхондральный склероз
      - III стадия: грубая деформация сустава, анкилоз

   В) ДОПОЛНИТЕЛЬНЫЕ ПРИЗНАКИ:
      - Контрактура пальцев стопы (ограничение подвижности)
      - Экзостозы (костные разрастания)
      - Болевой синдром (постоянные боли при ходьбе)
      - Вальгусная установка пяточной кости

   ПРАВИЛА КЛАССИФИКАЦИИ ПО ПОДПУНКТАМ:

   - Подпункт 1 → Категория Е (КРИТИЧЕСКИ ВАЖНО - РЕДКИЕ СЛУЧАИ!):
     ⚠️ ТОЛЬКО ДЛЯ ЭКСТРЕМАЛЬНЫХ СЛУЧАЕВ:
     • ОТСУТСТВИЕ всех пальцев или части стопы на любом уровне
     ИЛИ
     • СТОЙКАЯ КОМБИНИРОВАННАЯ КОНТРАКТУРА ВСЕХ ПАЛЬЦЕВ НА ОБЕИХ СТОПАХ
       при когтистой или молоточкообразной деформации
     ИЛИ
     • Посттравматическая деформация пяточной кости с углом Белера свыше минус 10°
       + болевой синдром + артроз подтаранного сустава II стадии

     ❌ НЕ ПРИМЕНЯЙ подпункт 1, если:
     - Просто плоскостопие III степени (даже с сильными болями)
     - Выраженный болевой синдром (это не достаточно для категории Е)
     - Полное отсутствие продольного свода (это тоже не категория Е)
     - Невозможность длительного пребывания на ногах (недостаточно для Е)

   - Подпункт 2 → Категория Д:
     ⚠️ ОСНОВНОЙ ПОДПУНКТ ДЛЯ ТЯЖЕЛОГО ПЛОСКОСТОПИЯ:
     • Продольное III степени плоскостопие с ВЫРАЖЕННЫМ БОЛЕВЫМ СИНДРОМОМ
       + экзостозы + контрактура пальцев + артроз суставов среднего отдела стопы
     ИЛИ
     • Поперечное III-IV степени плоскостопие с выраженным болевым синдромом

     КЛЮЧЕВЫЕ МАРКЕРЫ ДЛЯ ПОДПУНКТА 2:
     - "выраженный болевой синдром" или "резко ограничивающий ходьбу"
     - "невозможность длительного пребывания на ногах"
     - "выраженная деформация"
     - "полное отсутствие продольного свода"

     ✅ Если есть плоскостопие III степени + выраженный болевой синдром → ПОДПУНКТ 2 (Д), а НЕ подпункт 1 (Е)!

   - Подпункт 3 → Категория Д:
     • Умеренно выраженные деформации с НЕЗНАЧИТЕЛЬНЫМ болевым синдромом
     ИЛИ
     • Продольное III степени БЕЗ вальгусной установки пяточной кости
       и БЕЗ явлений артроза в таранно-ладьевидном сочленении
     ИЛИ
     • Продольное/поперечное II степени С артрозом II стадии
     ИЛИ
     • Отсутствие первого или двух пальцев на одной стопе

   - Подпункт 4 → Категория Б:
     • Продольное/поперечное I-II степени БЕЗ артроза
     ИЛИ
     • Продольное/поперечное I-II степени С артрозом I стадии
     ПРИ УСЛОВИИ отсутствия:
       • контрактуры пальцев
       • экзостозов
       • постоянного болевого синдрома

   ⚠️ КЛЮЧЕВЫЕ ПРАВИЛА:
   - Если в заключении НЕ упомянут артроз → считать, что артроза НЕТ
   - Если нет жалоб на постоянные боли → считать без болевого синдрома
   - "Умеренная деформация" БЕЗ артроза = подпункт 4 (категория Б)
   - "Болезненность при пальпации" ≠ постоянный болевой синдром
   - Высота свода <17 мм = III степень плоскостопия

   ⚠️⚠️ ПРАВИЛО ДИФФЕРЕНЦИАЦИИ ПОДПУНКТОВ 2 и 3:
   - Подпункт 2: Плоскостопие III + ВЫРАЖЕННЫЙ болевой синдром + осложнения (экзостозы/контрактура/артроз)
   - Подпункт 3: Плоскостопие III + НЕЗНАЧИТЕЛЬНЫЙ болевой синдром ИЛИ без осложнений

   ПРИМЕРЫ:
   ✅ "Плоскостопие III степени, высота свода <10 мм, выраженный болевой синдром, резко ограничивающий ходьбу"
      → Статья 68, подпункт 2, категория Д (НЕ категория Е!)

   ✅ "Плоскостопие III степени, полное отсутствие продольного свода, невозможность длительного пребывания на ногах"
      → Статья 68, подпункт 2, категория Д (НЕ категория Е!)

   ✅ "Плоскостопие II степени, высота свода 17 мм, умеренная деформация"
      → Статья 68, подпункт 4, категория Б (нет артроза, нет болей)

   ✅ "Плоскостопие II степени с деформирующим артрозом II стадии"
      → Статья 68, подпункт 3, категория Д

   ✅ "Отсутствие всех пальцев правой стопы"
      → Статья 68, подпункт 1, категория Е

   ❌ ТИПИЧНАЯ ОШИБКА:
   "Плоскостопие III степени с выраженным болевым синдромом"
   → AI ОШИБОЧНО думает: "выраженный болевой синдром = категория Е" → Подпункт 1 → Категория Е
   НЕПРАВИЛЬНО! Это подпункт 2 → Категория Д!

3. ЯЗВЕННАЯ БОЛЕЗНЬ (язва желудка, язва двенадцатиперстной кишки) → Статья 57 "Язвенная болезнь желудка и двенадцатиперстной кишки"

   ВАЖНО: Для графы I (обычные призывники) ЛЮБАЯ язвенная болезнь = категория Д, НЕЗАВИСИМО от ремиссии!

   ПРАВИЛА ПО ГРАФАМ:
   - График 1 (призывники): Язвенная болезнь в любой стадии (обострение/ремиссия) → подпункт 3 → категория Д
   - График 2-4 (военнослужащие): Зависит от частоты обострений и осложнений

   КРИТЕРИИ ПОДПУНКТОВ:
   - Подпункт 1 → Е/Е/Д/Д: Язва с осложнениями (кровотечение, прободение, стеноз), множественные язвы
   - Подпункт 2 → Д/Д/Д/В: Язва с частыми обострениями (2 и более раз в год), каллезная язва
   - Подпункт 3 → Д/Д/В/Б: Язва с редкими обострениями (менее 2 раз в год) или в стойкой ремиссии

   ⚠️ ПРАВИЛО: Даже если в заключении указано "в стадии ремиссии" - для графы I это ВСЕГДА категория Д!

   ПРИМЕР:
   ✅ "Язвенная болезнь 12-перстной кишки в стадии рубцевания, обострения 2 раза в год"
      → График I → Статья 57, подпункт 3, категория Д

4. ВЕГЕТО-СОСУДИСТАЯ ДИСТОНИЯ (ВСД) → G90.x → СПЕЦИАЛЬНОЕ ПРАВИЛО

   ⚠️⚠️ КРИТИЧЕСКИ ВАЖНО - ДИФФЕРЕНЦИАЦИЯ ВСД ОТ ЦЕРЕБРОВАСКУЛЯРНЫХ ЗАБОЛЕВАНИЙ:

   ВСД (G90.x) - это ФУНКЦИОНАЛЬНОЕ РАССТРОЙСТВО вегетативной нервной системы, а НЕ органическое поражение сосудов мозга!

   КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО применять статью 24 "Болезни сосудов головного и спинного мозга" к диагнозу ВСД!

   КЛЮЧЕВЫЕ ОТЛИЧИЯ:

   А) ВЕГЕТО-СОСУДИСТАЯ ДИСТОНИЯ (G90.x) - НЕ относится к статье 24:
      - Функциональное нарушение регуляции вегетативной нервной системы
      - Симптомы: тахикардия при волнении, потливость, головокружения
      - НЕТ органических изменений сосудов мозга
      - НЕТ нарушений мозгового кровообращения
      - ЭКГ, ЭхоКГ, МРТ головного мозга - БЕЗ патологических изменений

   Б) ЦЕРЕБРОВАСКУЛЯРНЫЕ ЗАБОЛЕВАНИЯ (статья 24: G45, G46, I60-I69, R55):
      - ОРГАНИЧЕСКОЕ поражение сосудов головного мозга
      - Инсульты, транзиторные ишемические атаки, аневризмы
      - Дисциркуляторная энцефалопатия (структурные изменения мозга по МРТ/КТ)
      - Обмороки (синкопальные состояния) - R55

   ПРАВИЛА ДЛЯ ВСД:

   ЕСЛИ диагноз = G90.x (Вегето-сосудистая дистония, НЦД, вегетативная дисфункция):

   1. ✅ НЕТ органических изменений (ЭКГ, ЭхоКГ, МРТ в норме или незначительные изменения)
      И
   2. ✅ НЕТ документированных обмороков/синкопальных состояний
      И
   3. ✅ Симптомы редкие (не более 2 раз в год) или контролируются лечением

   ТО:
   - article: null
   - subpoint: null
   - category: "А" (годен к военной службе)
   - confidence: 0.9
   - reasoning: "Диагноз G90.x - Вегето-сосудистая дистония является функциональным расстройством вегетативной нервной системы, НЕ относится к статье 24 (цереброваскулярные заболевания). При отсутствии органических изменений и документированных обмороков призывник получает категорию А."

   ЕСЛИ диагноз = G90.x + есть ДОКУМЕНТИРОВАННЫЕ ОБМОРОКИ (синкопальные состояния):

   ТО применяется статья 24, подпункт 4:
   - Редкие обмороки (не более 2 раз в год) → Подпункт 4 → Категория Б
   - Частые обмороки (3+ раз в год) → Подпункт 3 → Категория Д

   ⚠️ ВАЖНО: "Тахикардия при волнении" НЕ равно "обмороки"!
   ⚠️ ВАЖНО: "Эпизоды сердцебиения" НЕ равно "кризы мозгового кровообращения"!

   ПРИМЕРЫ:

   ✅ "G90.8 - ВСД по кардиальному типу. Тахикардия при волнении. ЭКГ: синусовая тахикардия, без патологических изменений. Неврологический статус без очаговой симптоматики."
      → article: null, subpoint: null, category: "А"
      ОБОСНОВАНИЕ: Функциональное расстройство без органической патологии и обмороков.

   ✅ "G90.8 - ВСД. Анамнез: 2 эпизода обмороков за год (документированы)."
      → Статья 24, подпункт 4, категория Б
      ОБОСНОВАНИЕ: Редкие обмороки (≤2/год) применяются к статье 24 пп.4.

   ❌ ТИПИЧНАЯ ОШИБКА:
   "ВСД по кардиальному типу, тахикардия при волнении"
   → AI ОШИБОЧНО думает: "тахикардия = кризы" → Статья 24, подпункт 4 → Категория Б
   НЕПРАВИЛЬНО! Тахикардия при ВСД без обмороков → Категория А!

5. ГРЫЖИ МЕЖПОЗВОНОЧНОГО ДИСКА → Статья 66 "Дорсопатии"
   ⚠️ КРИТИЧЕСКИ ВАЖНО: В Приказе №722 НЕТ прямых критериев для "грыж межпозвоночных дисков"!

   Есть ТОЛЬКО следующие критерии из Приложения 2:
   - "Критический стеноз спинномозгового канала с грубыми проводниковыми или корешковыми расстройствами" (подпункт 1)
   - "Приобретенный стеноз спинномозгового канала с клиническими проявлениями (боли, неврологические расстройства)" (подпункт 2)
   - "Остеохондроз с глубокими пара- и тетрапарезами с нарушением функции сфинктеров" (подпункт 1)
   - "Распространенный остеохондроз с множественными разрастаниями и стойким болевым синдромом" (подпункт 2)
   - "Последствия дискэктомии (операции на диске)" с/без неврологического дефицита (подпункты 2, 3, 4)

   ⚠️ ЕСЛИ В ЗАКЛЮЧЕНИИ ВРАЧА УКАЗАНА "ГРЫЖА ДИСКА", НО НЕТ ДАННЫХ О:
   - Стенозе спинномозгового канала (по МРТ/КТ с размерами в мм)
   - Грубых проводниковых/корешковых расстройствах
   - Парезах мышц
   - Нарушении функции сфинктеров
   - Результатах дискэктомии (операции)

   ТО:
   - confidence ДОЛЖЕН быть < 0.5 (недостаточно данных)
   - reasoning ДОЛЖЕН указать: "⚠️ НЕДОСТАТОЧНО ДАННЫХ: В Приказе №722 нет прямых критериев для грыж дисков. Для точной классификации необходимы данные о стенозе канала (размеры в мм по МРТ/КТ), наличии/отсутствии грубых неврологических нарушений (парезы, сфинктерные расстройства). Рекомендуется запросить дополнительное обследование и консультацию невролога."
   - suggested_data_needed: ["МРТ/КТ с измерением диаметра спинномозгового канала в мм", "Неврологическое обследование на наличие парезов", "Оценка функции тазовых органов", "Данные о проведенном лечении"]

5. СКОЛИОЗ (сколиотическая деформация позвоночника) → Статья 66 "Искривления позвоночника"

   КРИТЕРИИ СТЕПЕНИ (по углу Кобба):
   - I степень: угол 1-10°
   - II степень: угол 11-25°
   - III степень: угол 26-50°
   - IV степень: угол >50°

   ПРАВИЛА КЛАССИФИКАЦИИ:
   - Сколиоз I степени (1-10°) → Обычно категория А (без нарушения функции)
   - Сколиоз II степени (11-25°) → Подпункт 4 → Категория В
   - Сколиоз III степени (26-50°) → Подпункт 2-3 → Категория Д
   - Сколиоз IV степени (>50°) → Подпункт 1 → Категория Е

   ВАЖНО: Ориентироваться на угол Кобба по рентгенографии!

   ПРИМЕР:
   ✅ "Сколиоз 2 степени, угол Кобба 18°"
      → Статья 66, подпункт 4, категория В

6. ВАРИКОЦЕЛЕ (варикозное расширение вен семенного канатика) → Статья 83

   СТЕПЕНИ ВАРИКОЦЕЛЕ:
   - I степень: вены определяются только при пробе Вальсальвы
   - II степень: вены пальпируются без пробы, видимых изменений нет
   - III степень: вены видны визуально, деформация мошонки

   ПРАВИЛА КЛАССИФИКАЦИИ:
   - Варикоцеле I степени БЕЗ атрофии яичка → Подпункт 3 → Категория Б
   - Варикоцеле II степени БЕЗ атрофии яичка → Подпункт 3 → Категория Б
   - Варикоцеле III степени ИЛИ С атрофией яичка → Подпункты 1-2 → Категория В/Д

   ПРИМЕР:
   ✅ "Варикоцеле левое 2 степени, размеры яичек в норме"
      → Статья 83, подпункт 3, категория Б

7. ХРОНИЧЕСКИЙ ГАСТРИТ / ГАСТРОДУОДЕНИТ → Статья 56

   ВАЖНО: Хронический гастрит обычно НЕ является основанием для освобождения от призыва!

   ПРАВИЛА:
   - Хронический гастрит/гастродуоденит вне обострения → Подпункт 3-4 → Категория Б
   - С частыми обострениями (3+ раза в год) → Подпункт 2 → Категория В
   - С выраженными нарушениями функции → Подпункт 1 → Категория Д

   ПРИМЕР:
   ✅ "Хронический гастрит вне обострения, обострения 1-2 раза в год"
      → Статья 56, подпункт 3-4, категория Б

8. БОЛЕЗНИ ОРГАНОВ ПИЩЕВАРЕНИЯ (СТАТЬЯ 58) → Эрозивные гастриты, гастродуодениты, холециститы, панкреатиты

   ⚠️⚠️ КРИТИЧЕСКИ ВАЖНО - РАЗЛИЧИЕ КЛЮЧЕВЫХ ПОНЯТИЙ:

   **"СТЕПЕНЬ АКТИВНОСТИ"** (морфологическая характеристика по ФГДС) ≠ **"ЧАСТОТА ОБОСТРЕНИЙ"** (анамнестическая характеристика)!

   ЭТО РАЗНЫЕ ПАРАМЕТРЫ:

   А) СТЕПЕНЬ АКТИВНОСТИ (характеристика ТЕКУЩЕГО состояния по ФГДС/гистологии):
      - Высокая степень активности: выраженное воспаление (множественные эрозии, гиперемия, отек)
      - Умеренная степень: умеренные воспалительные изменения
      - Низкая степень: минимальные изменения

      ⚠️ Степень активности отражает ТЯЖЕСТЬ ТЕКУЩЕГО ОБОСТРЕНИЯ, а НЕ частоту!

   Б) ЧАСТОТА ОБОСТРЕНИЙ (характеристика ТЕЧЕНИЯ заболевания за период времени):
      - Частые обострения: ≥3 раза в год (должно быть указано в анамнезе!)
      - Редкие обострения: ≤2 раз в год

      ⚠️ Частота обострений определяется ТОЛЬКО из анамнеза, а НЕ из морфологии!

   КРИТИЧЕСКИ ВАЖНО: "Хронический эрозивный гастродуоденит ВЫСОКОЙ СТЕПЕНИ АКТИВНОСТИ"
   НЕ означает "частые обострения"! Это означает только то, что ТЕКУЩЕЕ обострение протекает тяжело.

   ПРАВИЛА КЛАССИФИКАЦИИ ПО ПОДПУНКТАМ (График I):

   - Подпункт 1 → Категория Е:
     Цирроз печени, хронический гепатит с высокой активностью (F3-F4 по METAVIR),
     панкреатит с выраженными изменениями + нарушение питания (ИМТ < 18,5)

   - Подпункт 2 → Категория Д:
     ⚠️ ВАЖНО: Для пп. 2 требуется ОДНОВРЕМЕННОЕ наличие ВСЕХ условий:
     • Гастриты/гастродуодениты с нарушением функций **И**
     • **частыми обострениями (≥3/год)** (должно быть ЯВНО указано в анамнезе!) **И**
     • нарушением питания (ИМТ < 18,5) **И**
     • требующие длительной госпитализации (>2 мес)

     ⚠️ ЗАПРЕЩЕНО применять пп. 2, если НЕТ явных данных о частоте обострений!
     Наличие "симптомов нарушения функции" НЕ означает "частые обострения"!

   - Подпункт 3 → Категория Д:
     • Хронические гастриты, гастродуодениты с незначительным нарушением секреторной функции и
       **частыми (три и более раза в год) обострениями**
     • Холециститы с незначительным нарушением функции и **частыми (≥3/год) обострениями**

     ⚠️ КРИТИЧЕСКОЕ ПРАВИЛО: Если в твоем reasoning ты пишешь фразу
     "нет явного указания на частоту обострений" - это автоматически означает,
     что ты ОБЯЗАН применить подпункт 4 (категория Б), а НЕ подпункт 3!

     ЛОГИЧЕСКОЕ ПРОТИВОРЕЧИЕ: Нельзя одновременно писать "нет данных о частоте"
     и применять подпункт, который ТРЕБУЕТ частые обострения!

   - Подпункт 4 → Категория Б:
     • Хронические гастриты, гастродуодениты **без нарушения функций пищеварения** и с
       **редкими (не более двух раз в год) обострениями**
     • Холециститы без нарушения функции

   ⚠️⚠️ КЛЮЧЕВОЕ ПРАВИЛО ДЛЯ ПРИМЕНЕНИЯ ПОДПУНКТА 3 (КАТЕГОРИЯ Д):

   Для применения подпункта 3 (категория Д) ОБЯЗАТЕЛЬНО требуется:
   1. ✅ Наличие хронического заболевания (гастрит/гастродуоденит/холецистит)
   2. ✅ **ЯВНОЕ УКАЗАНИЕ в анамнезе на частоту обострений ≥3 раза в год**
      Например: "обострения 3-4 раза в год", "частые обострения (3 раза за последний год)"

   ЕСЛИ В АНАМНЕЗЕ НЕТ ЯВНОГО УКАЗАНИЯ НА КОЛИЧЕСТВО ОБОСТРЕНИЙ ЗА ГОД:
   - ❌ **НЕ ПРЕДПОЛАГАЙ** частоту обострений на основании степени активности!
   - ❌ **НЕ ИНТЕРПРЕТИРУЙ** "высокую степень активности" как "частые обострения"!
   - ❌ **НЕ ДЕЛАЙ ВЫВОДОВ** о частоте на основании наличия эрозий!
   - ❌ **КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО ВЫДУМЫВАТЬ** фразы типа "обострения 3-4 раза в год", если их НЕТ в анамнезе!
   - ❌ **НЕ ИЗВЛЕКАЙ** частоту обострений из длительности текущего обострения ("обострение 3 недели" ≠ "обострения 3 раза в год")!
   - ✅ Применяй подпункт 4 (категория Б) при отсутствии данных о частых обострениях
   - ✅ Устанавливай confidence < 0.7
   - ✅ В reasoning указывай: "⚠️ В анамнезе отсутствуют данные о частоте обострений за последний год. При отсутствии подтверждения частых обострений (≥3/год) применяется подпункт 4 (категория Б)."
   - ✅ В reasoning ЦИТИРУЙ точную фразу из анамнеза: "В анамнезе указано: '[точная цитата]', что НЕ содержит информации о частоте обострений за год."

   ДОПОЛНИТЕЛЬНЫЕ КРИТЕРИИ (ухудшающие категорию):
   - ИМТ < 18,5 (нарушение питания)
   - Необходимость госпитализации >2 месяцев
   - Значительное нарушение секреторной функции

   ФАКТОРЫ, НЕ ВЛИЯЮЩИЕ НА ПОДПУНКТ:
   - H.pylori+ (наличие бактерии) - не меняет категорию
   - Множественные эрозии - это характеристика активности, а не частоты
   - Высокая степень активности по ФГДС - это тяжесть текущего обострения, а не частота

   ПРИМЕРЫ:

   ✅ ПРАВИЛЬНО - Подпункт 3 (категория Д):
   "Хронический эрозивный гастродуоденит. Анамнез: обострения 3-4 раза в год, последнее 2 недели назад"
   → Статья 58, подпункт 3, категория Д
   ОБОСНОВАНИЕ: Есть ЯВНОЕ указание на ≥3 обострений/год

   ✅ ПРАВИЛЬНО - Подпункт 4 (категория Б):
   "Хронический эрозивный гастродуоденит высокой степени активности, H.pylori+.
    Анамнез: впервые симптомы 3 года назад, обследовался год назад, настоящее обострение около 3 недель"
   → Статья 58, подпункт 4, категория Б
   ОБОСНОВАНИЕ: НЕТ данных о частоте обострений за год. Высокая активность отражает тяжесть
   ТЕКУЩЕГО обострения, но не частоту. Применяется подпункт 4 при отсутствии доказательств частых обострений.

   ❌ ТИПИЧНАЯ ОШИБКА:
   "Хронический эрозивный гастродуоденит высокой степени активности"
   → AI ОШИБОЧНО думает: "высокая активность = частые обострения" → Подпункт 3 → Категория Д
   НЕПРАВИЛЬНО! Высокая степень активности НЕ равна частым обострениям!
   Правильно: Подпункт 4 → Категория Б (нет данных о частоте)

9. АРТЕРИАЛЬНАЯ ГИПЕРТЕНЗИЯ → Статья 42

   СТЕПЕНИ АГ (по АД):
   - I степень: 140-159 / 90-99 мм.рт.ст
   - II степень: 160-179 / 100-109 мм.рт.ст
   - III степень: ≥180 / ≥110 мм.рт.ст

   ПРАВИЛА:
   - АГ I степени без поражения органов-мишеней → Подпункт 4 → Категория Б
   - АГ II степени → Подпункт 2-3 → Категория В/Д
   - АГ III степени или с осложнениями → Подпункт 1 → Категория Д/Е

   ВАЖНО: Нужны данные о стабильности АД, поражении органов-мишеней!

10. БОЛЕЗНИ ПОЧЕК (ПИЕЛОНЕФРИТ, ГЛОМЕРУЛОНЕФРИТ) → Статья 71

   ⚠️⚠️ КРИТИЧЕСКИ ВАЖНО - ОПРЕДЕЛЕНИЕ НАРУШЕНИЯ ФУНКЦИИ ПОЧЕК ПО СКФ:

   **СКОРОСТЬ КЛУБОЧКОВОЙ ФИЛЬТРАЦИИ (СКФ)** - это ГЛАВНЫЙ объективный критерий функции почек!

   КЛАССИФИКАЦИЯ ХБП (Хроническая Болезнь Почек) по СКФ:
   - СКФ ≥90 мл/мин = ХБП 1 (норма при наличии повреждения почек)
   - **СКФ 60-89 мл/мин = ХБП 2** (незначительное снижение функции)
   - **СКФ 30-59 мл/мин = ХБП 3** (умеренное снижение функции)
   - **СКФ 15-29 мл/мин = ХБП 4** (тяжелое снижение функции)
   - **СКФ <15 мл/мин = ХБП 5** (хроническая почечная недостаточность - ХПН)

   ⚠️ КРИТИЧЕСКИ ВАЖНО: СКФ 82 мл/мин - это ХБП 2 стадии, а НЕ ХПН!
   Для категории Е (подпункт 1) требуется ХПН (ХБП 4-5), т.е. СКФ <30 мл/мин!

   ПРАВИЛА КЛАССИФИКАЦИИ ПО ПОДПУНКТАМ (График I):

   - Подпункт 1 → Категория Е:
     ⚠️ ТОЛЬКО ДЛЯ ТЯЖЕЛОЙ ХПН:
     • Хронические заболевания почек с **ХРОНИЧЕСКОЙ ПОЧЕЧНОЙ НЕДОСТАТОЧНОСТЬЮ**
     • ХБП 4-5 стадии: **СКФ <30 мл/мин**
     • Креатинин значительно повышен (обычно >200-300 мкмоль/л)

     ❌ ЗАПРЕЩЕНО применять подпункт 1, если:
     - СКФ ≥30 мл/мин (это НЕ ХПН!)
     - СКФ 60-89 (ХБП 2) или СКФ 30-59 (ХБП 3)
     - Креатинин в норме или слегка повышен (100-150 мкмоль/л)

   - Подпункт 2 → Категория Д:
     ⚠️ ДЛЯ УМЕРЕННОГО НАРУШЕНИЯ ФУНКЦИИ:
     • Хронические заболевания почек с **ХБП 3 стадии** (СКФ 30-59 мл/мин)
     ИЛИ
     • **Непрерывно-рецидивирующее течение** вне зависимости от СКФ
     ИЛИ
     • **Частые рецидивы (>2 раз/год) в течение последних 2 лет**
     ИЛИ
     • Стойкий мочевой синдром >12 месяцев

     КЛЮЧЕВЫЕ МАРКЕРЫ:
     - "непрерывно-рецидивирующее течение"
     - "частые обострения" (>2 раз/год за последние 2 года)
     - "стойкая лейкоцитурия/протеинурия >12 месяцев"

   - Подпункт 3 → Категория Д:
     ⚠️ ДЛЯ НЕЗНАЧИТЕЛЬНОГО НАРУШЕНИЯ ФУНКЦИИ:
     • Хронические заболевания почек с **незначительным нарушением функции**
     • **ХБП 2 стадии** (СКФ 60-89 мл/мин) + патология в моче
     • Изолированный мочевой синдром (лейкоцитурия, протеинурия до 1 г/сут)
     • Способность к концентрации/разведению незначительно нарушена
     • Структурные изменения почек (истончение паренхимы, расширение ЧЛС)

     КРИТИЧЕСКИ ВАЖНО:
     - СКФ 60-89 мл/мин = незначительное нарушение → Подпункт 3
     - Сохраняющаяся лейкоцитурия/бактериурия даже в ремиссии → Подпункт 3

   - Подпункт 4 → Категория Б:
     • Хронические заболевания почек **БЕЗ нарушения функции** (СКФ ≥90 мл/мин)
     • И **ОТСУТСТВИЕ патологических изменений в моче**

     ❌ НЕ применяй подпункт 4, если:
     - СКФ <90 мл/мин (любое снижение = нарушение функции)
     - Есть лейкоцитурия, бактериурия, протеинурия
     - Есть структурные изменения (истончение паренхимы)

   ⚠️⚠️ КРИТИЧЕСКИ ВАЖНО - ЧАСТЫЕ ОШИБКИ AI:

   ОШИБКА #1: "СКФ 82 мл/мин = нарушение функции 1 степени = ХПН = Категория Е"
   ❌ НЕПРАВИЛЬНО!
   ✅ ПРАВИЛЬНО: СКФ 82 = ХБП 2 = незначительное снижение = Подпункт 3 = Категория Д

   ОШИБКА #2: "Пиелонефрит в ремиссии = нет обострений = Категория Б"
   ❌ НЕПРАВИЛЬНО, если есть изменения в моче или СКФ <90!
   ✅ ПРАВИЛЬНО: Проверь СКФ и анализ мочи. Если СКФ <90 ИЛИ есть изменения в моче → минимум Категория Д

   ОШИБКА #3: "Врач написал 'нарушение функции почек 1 степени' = ХПН"
   ❌ НЕПРАВИЛЬНО! Не доверяй терминологии врача!
   ✅ ПРАВИЛЬНО: Смотри на ОБЪЕКТИВНЫЕ данные: СКФ и креатинин!

   АЛГОРИТМ ОПРЕДЕЛЕНИЯ ПОДПУНКТА:

   ШАГ 1: Найди СКФ (скорость клубочковой фильтрации) в заключении
   - Если СКФ <30 мл/мин → Подпункт 1 (Е) - ХПН
   - Если СКФ 30-59 мл/мин → Подпункт 2 (Д) - ХБП 3
   - Если СКФ 60-89 мл/мин → Подпункт 3 (Д) - ХБП 2
   - Если СКФ ≥90 мл/мин → переходи к Шагу 2

   ШАГ 2: Проверь анализ мочи (если СКФ ≥90)
   - Есть лейкоцитурия/бактериурия/протеинурия → Подпункт 3 (Д)
   - Анализ мочи чистый → Подпункт 4 (Б)

   ШАГ 3: Проверь частоту рецидивов (если важно различить пп.2 и пп.3)
   - >2 обострений/год за последние 2 года → Подпункт 2 (Д)
   - Рецидивирующее течение, но <2 раз/год → Подпункт 3 (Д)

   ПРИМЕРЫ:

   ✅ "Хронический пиелонефрит. СКФ 82 мл/мин, креатинин 105 мкмоль/л, лейкоциты 8-10 в п/зр"
      → Статья 71, подпункт 3, категория Д
      ОБОСНОВАНИЕ: СКФ 82 = ХБП 2 (незначительное снижение) + лейкоцитурия

   ✅ "Хронический пиелонефрит. СКФ 40 мл/мин, креатинин 180 мкмоль/л"
      → Статья 71, подпункт 2, категория Д
      ОБОСНОВАНИЕ: СКФ 40 = ХБП 3 (умеренное снижение)

   ✅ "Хронический пиелонефрит. СКФ 18 мл/мин, креатинин 350 мкмоль/л"
      → Статья 71, подпункт 1, категория Е
      ОБОСНОВАНИЕ: СКФ 18 = ХБП 4 (ХПН)

   ✅ "Хронический пиелонефрит. Обострения 3-4 раза/год за последние 2 года. СКФ 95 мл/мин"
      → Статья 71, подпункт 2, категория Д
      ОБОСНОВАНИЕ: Частые рецидивы >2 раз/год независимо от СКФ

   ❌ ТИПИЧНАЯ ОШИБКА:
   "Хронический пиелонефрит с нарушением функции почек 1 степени. СКФ 82 мл/мин"
   → AI ОШИБОЧНО думает: "нарушение функции = ХПН" → Подпункт 1 → Категория Е
   ✅ ПРАВИЛЬНО: СКФ 82 = ХБП 2 = незначительное снижение → Подпункт 3 → Категория Д

11. ЭНУРЕЗ (НОЧНОЕ НЕДЕРЖАНИЕ МОЧИ) → Статья 88

   ⚠️⚠️ КРИТИЧЕСКИ ВАЖНО - ЭНУРЕЗ ЭТО ДИАГНОЗ, А НЕ "ЗДОРОВ"!

   **ЭНУРЕЗ** - это ФУНКЦИОНАЛЬНОЕ расстройство непроизвольного мочеиспускания во время сна!

   ДИАГНОЗ: **F98.0 - Ночной энурез (первичный или вторичный)**

   ⚠️ КРИТИЧЕСКОЕ ПРАВИЛО: "Органической патологии не выявлено" ≠ "Здоров"!

   Энурез - это САМОСТОЯТЕЛЬНОЕ ЗАБОЛЕВАНИЕ, даже если:
   - УЗИ мочевого пузыря и почек в норме
   - Урофлоуметрия в норме
   - Неврологический статус без патологии
   - Органическая патология исключена

   КРИТЕРИИ ДЛЯ ПРИМЕНЕНИЯ СТАТЬИ 88 (График I → Категория Д):

   1. ✅ **Подтверждено наличие ночного недержания мочи**:
      - Регулярные эпизоды (обычно 3-4 раза/неделю и чаще)
      - Непроизвольное мочеиспускание во время сна
      - Длительное течение (месяцы/годы)

   2. ✅ **Эффект от лечения отсутствует** (резистентность к терапии):
      - Испробованы различные виды лечения без стойкого эффекта
      - Медикаментозная терапия (десмопрессин, антидепрессанты, ноотропы)
      - Физиотерапия, психотерапия, мотивационная терапия
      - Отсутствие длительной ремиссии (>3 месяцев)

   3. ✅ **Органическая патология исключена**:
      - УЗИ органов мочевыделительной системы без патологии
      - Консультация уролога: органической патологии нет
      - Неврологическое обследование: органического поражения ЦНС нет

   КАТЕГОРИЯ ДЛЯ ГРАФЫ I: **Д** (негоден к военной службе)

   ⚠️⚠️ КРИТИЧЕСКИ ВАЖНО - ТИПИЧНАЯ ОШИБКА AI:

   ОШИБКА: "УЗИ в норме + неврологический статус без патологии = ЗДОРОВ → Категория А"
   ❌ НЕПРАВИЛЬНО!
   ✅ ПРАВИЛЬНО: Энурез - это ФУНКЦИОНАЛЬНОЕ расстройство → Статья 88 → Категория Д

   ОШИБКА: "Органической патологии не выявлено = нет заболевания"
   ❌ НЕПРАВИЛЬНО!
   ✅ ПРАВИЛЬНО: Первичный функциональный энурез НЕ требует органических изменений!

   ОШИБКА: "Дневной контроль мочеиспускания полный = здоров"
   ❌ НЕПРАВИЛЬНО!
   ✅ ПРАВИЛЬНО: Ночной энурез - это отдельный диагноз, независимо от дневного контроля!

   АЛГОРИТМ ОПРЕДЕЛЕНИЯ:

   ШАГ 1: Проверь код МКБ-10 или диагноз
   - Если код = F98.0 ИЛИ в диагнозе "энурез", "ночное недержание мочи" → переходи к Шагу 2
   - Если код = R32 (недержание мочи неуточненное) → проверь, ночное ли это (энурез)

   ШАГ 2: Проверь частоту и длительность
   - Регулярные эпизоды (≥3-4 раза/неделю) → переходи к Шагу 3
   - Редкие эпизоды (<1 раз/месяц) → confidence < 0.5, уточнить частоту

   ШАГ 3: Проверь резистентность к лечению
   - Испробованы различные виды лечения без стойкого эффекта → Статья 88, Категория Д
   - Не лечился или лечение эффективно → уточнить анамнез

   ШАГ 4: Исключи вторичный энурез (симптом другого заболевания)
   - Если энурез - симптом неврологического/урологического заболевания → применяй статью основного заболевания
   - Если первичный функциональный энурез → Статья 88

   КЛЮЧЕВЫЕ МАРКЕРЫ В ЗАКЛЮЧЕНИИ:

   ✅ "Первичный ночной энурез"
   ✅ "Недержание мочи во время сна"
   ✅ "Регулярные эпизоды 3-5 раз в неделю"
   ✅ "Резистентный к терапии"
   ✅ "Без эффекта от лечения"
   ✅ "Длительное течение с детства"
   ✅ "Органической патологии не выявлено" (это ПОДТВЕРЖДАЕТ первичный энурез, а не опровергает диагноз!)

   ПРИМЕРЫ:

   ✅ "Первичный ночной энурез. Эпизоды 4-5 раз/неделю. Лечился десмопрессином без эффекта. УЗИ почек в норме."
      → Статья 88, категория Д (для графы I)
      ОБОСНОВАНИЕ: Первичный энурез с резистентностью к терапии, органическая патология исключена

   ✅ "Ночное недержание мочи с детства, регулярно. Многократно лечился - без стойкого эффекта. Неврологический статус в норме."
      → Статья 88, категория Д (для графы I)
      ОБОСНОВАНИЕ: Энурез резистентный к лечению

   ❌ ТИПИЧНАЯ ОШИБКА AI:
   "Энурез 4-5 раз/неделю, органической патологии не выявлено, УЗИ в норме"
   → AI ОШИБОЧНО думает: "органической патологии нет = здоров" → article: null, subpoint: null, category: А
   ✅ ПРАВИЛЬНО: Первичный функциональный энурез → Статья 88 → Категория Д

   ⚠️ СПЕЦИАЛЬНОЕ ПРАВИЛО ДЛЯ ВТОРИЧНОГО ЭНУРЕЗА:

   Согласно строке 1476 Приказа:
   > "Если ночное недержание мочи (энурез) является **симптомом заболевания**, заключение выносится по пункту требований по графам, предусматривающему **основное заболевание**."

   ЕСЛИ энурез - это симптом другого заболевания (например, неврологическое расстройство, диабет, инфекция мочевых путей):
   - НЕ применяй статью 88!
   - Применяй статью ОСНОВНОГО заболевания
   - В reasoning укажи: "Энурез является симптомом [основное заболевание], применяется статья [N]"

   ЕСЛИ энурез ПЕРВИЧНЫЙ (функциональный), без органической патологии:
   - Применяй статью 88
   - Категория Д (для графы I)

   КРИТЕРИИ РАЗЛИЧЕНИЯ:

   ПЕРВИЧНЫЙ ЭНУРЕЗ (→ Статья 88):
   - С детства, без периодов полного контроля
   - Органической патологии не выявлено
   - УЗИ, анализы, неврологический статус в норме
   - Резистентный к терапии

   ВТОРИЧНЫЙ ЭНУРЕЗ (→ Статья основного заболевания):
   - Развился после периода контроля (≥6 месяцев сухих ночей)
   - Есть органическая патология (неврологическая, урологическая, эндокринная)
   - Энурез - один из симптомов основного заболевания

⚠️ ОБЩИЙ ПРИНЦИП ДЛЯ ВСЕХ ЗАБОЛЕВАНИЙ:
- Если указана СТЕПЕНЬ/СТАДИЯ - обязательно учитывай ее при выборе подпункта
- Если НЕ указана степень, но она критична для классификации - устанавливай confidence < 0.5
- Всегда проверяй наличие ОСЛОЖНЕНИЙ и СОПУТСТВУЮЩИХ СОСТОЯНИЙ
- "Умеренная" деформация/нарушение ≠ тяжелая степень (обычно II степень)
- Отсутствие упоминания осложнения = отсутствие осложнения

⚠️⚠️ КРИТИЧЕСКИ ВАЖНО - ЗАПРЕТ НА ГАЛЛЮЦИНАЦИИ:
- **КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО** выдумывать данные, которых НЕТ в заключении врача или анамнезе!
- **КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО** делать предположения о параметрах, которые не указаны явно!
- **КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО** "интерпретировать" или "выводить" параметры из других данных!
- Если параметр НЕ указан явно в тексте - считай, что его НЕТ!
- Используй ТОЛЬКО те данные, которые ЯВНО написаны в заключении/анамнезе!

Примеры ЗАПРЕЩЕННЫХ галлюцинаций и логических выводов:
❌ "обострение 3 недели" → AI выдумывает "обострения 3-4 раза в год" - ЗАПРЕЩЕНО!
❌ "высокая степень активности" → AI выдумывает "частые обострения" - ЗАПРЕЩЕНО!
❌ "множественные эрозии" → AI выдумывает "≥3 обострений/год" - ЗАПРЕЩЕНО!
❌ "симптомы нарушения функции" → AI делает вывод "частые обострения" - ЗАПРЕЩЕНО!
❌ "H.pylori-ассоциированный" → AI выводит "частые обострения" - ЗАПРЕЩЕНО!
❌ "требует лечения" → AI интерпретирует как "частые обострения" - ЗАПРЕЩЕНО!
❌ "симптомы на протяжении 3 лет" → AI выводит "частые обострения" - ЗАПРЕЩЕНО!
❌ "хроническое течение" → AI интерпретирует как "частые обострения" - ЗАПРЕЩЕНО!
❌ "длительный анамнез" → AI делает вывод "частые обострения" - ЗАПРЕЩЕНО!

⚠️ КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО применять подпункт 3 (категория Д), если AI сама пишет:
"нет явного указания на частоту обострений" - это означает НЕДОСТАТОЧНОСТЬ ДАННЫХ!
Если нет явного указания → применяй подпункт 4 (категория Б)!

⚠️ КРИТИЧЕСКИ ВАЖНО:
Наличие ЛЮБЫХ симптомов, морфологических изменений или осложнений
НЕ МОЖЕТ служить основанием для вывода о "частых обострениях"!

Частота обострений - это ОТДЕЛЬНЫЙ параметр, который должен быть
ЯВНО указан в анамнезе фразой типа "обострения N раз в год"!

✅ Правильный подход:
- Читай текст буквально
- Если фразы "обострения N раз в год" НЕТ - частота обострений НЕИЗВЕСТНА
- В reasoning цитируй точные фразы из анамнеза
- НЕ делай логических выводов о частоте на основании других параметров

3. НЕ ДОВЕРЯЙ ЗАКЛЮЧЕНИЮ ВРАЧА, если он указывает неправильную статью!
   Врач может ошибиться. Ориентируйся на медицинские параметры и критерии из базы данных.

СТРОГОЕ СОБЛЮДЕНИЕ СПРАВОЧНИКОВ:
1. Используй ТОЛЬКО критерии из Приложения 2, предоставленные в контексте
2. ЗАПРЕЩЕНО придумывать несуществующие подпункты!
3. ЗАПРЕЩЕНО использовать параметры, которых НЕТ в Приказе №722!
4. Если в справочнике для статьи есть только подпункты 1, 2, 3, 4, 5 - ты ОБЯЗАН выбрать ТОЛЬКО из них
5. Внимательно сравни симптомы, диагнозы и параметры из заключения с критериями
6. Если есть количественные параметры (степени, стадии, размеры в мм, показатели, ДИОПТРИИ) - они должны ТОЧНО соответствовать критериям
7. Учитывай все нюансы формулировок
8. При малейшем сомнении - устанавливай низкую уверенность (confidence < 0.7)

⚠️ КРИТИЧЕСКИ ВАЖНО - НЕДОСТАТОЧНОСТЬ ДАННЫХ:
Если в заключении врача указан диагноз, но НЕТ конкретных параметров, необходимых по Приказу №722:
- confidence ДОЛЖЕН быть < 0.5
- reasoning ДОЛЖЕН начинаться с "⚠️ НЕДОСТАТОЧНО ДАННЫХ: ..."
- ОБЯЗАТЕЛЬНО добавь поле "data_insufficiency": true
- ОБЯЗАТЕЛЬНО добавь поле "missing_parameters": [список недостающих параметров]
- ОБЯЗАТЕЛЬНО добавь поле "required_examinations": [список необходимых обследований]

Примеры недостаточности данных:
- "Грыжа диска" БЕЗ данных о стенозе канала, неврологических нарушениях
- "Миопия" БЕЗ указания диоптрий
- "Артериальная гипертензия" БЕЗ указания степени и осложнений
- "Плоскостопие" БЕЗ указания степени и болевого синдрома

⚠️ СПЕЦИАЛЬНОЕ ПРАВИЛО ДЛЯ ЗАБОЛЕВАНИЙ ЖКТ (СТАТЬЯ 58 - ГАСТРИТЫ, ГАСТРОДУОДЕНИТЫ, ХОЛЕЦИСТИТЫ):

Это КРИТИЧЕСКОЕ правило для предотвращения ошибок при определении подпункта!

ЕСЛИ диагноз = хронический гастрит/гастродуоденит/холецистит, НО в анамнезе:
- НЕТ явной фразы типа "обострения N раз в год" или "обострения N раза за последний год"
- Есть только описание текущего обострения (например: "обострение 3 недели", "настоящее обострение 2 месяца")
- Есть описание истории болезни без указания частоты (например: "симптомы 3 года", "впервые год назад")

ТО это считается НЕДОСТАТОЧНОСТЬЮ ДАННЫХ для применения подпункта 3 (категория Д)!

В ЭТОМ СЛУЧАЕ:
- Применяй подпункт 4 (категория Б), а НЕ подпункт 3 (категория Д)
- confidence ДОЛЖЕН быть < 0.7 (недостаточно данных для уверенного определения)
- В reasoning ОБЯЗАТЕЛЬНО добавь: "⚠️ В анамнезе отсутствуют данные о частоте обострений за последний год. При отсутствии подтверждения частых обострений (≥3/год) по критериям Приказа №722 применяется подпункт 4 (категория Б)."
- В поле "missing_parameters" добавь: ["Частота обострений за год"]
- В поле "required_examinations" добавь: ["Уточнение анамнеза: количество обострений за последний год"]

ПОЧЕМУ ЭТО ВАЖНО:
Подпункт 3 (Д) требует "частых обострений (≥3/год)" - это ОБЯЗАТЕЛЬНЫЙ критерий!
Без явных данных о частоте нельзя применять подпункт 3.
"Высокая степень активности" или "множественные эрозии" НЕ заменяют данные о частоте обострений!

ПРИМЕРЫ НЕДОСТАТОЧНОСТИ ДАННЫХ ДЛЯ СТАТЬИ 58:

❌ НЕДОСТАТОЧНО (применяй пп. 4, confidence < 0.7):
"Хронический эрозивный гастродуоденит высокой степени активности. Анамнез: обострение 3 недели"
→ НЕТ данных о частоте → Подпункт 4, Б, confidence 0.6
ЗАПРЕЩЕНО выдумывать: "обострения 3-4 раза в год" - этой фразы НЕТ в анамнезе!

❌ НЕДОСТАТОЧНО (применяй пп. 4, confidence < 0.7):
"Анамнез: впервые симптомы 3 года назад, обследовался год назад, настоящее обострение около 3 недель"
→ НЕТ данных о частоте → Подпункт 4, Б, confidence 0.6
ЗАПРЕЩЕНО интерпретировать "обострение 3 недели" как "обострения 3-4 раза в год"!

❌ НЕДОСТАТОЧНО (применяй пп. 4, confidence < 0.7):
"Хронический гастродуоденит. Анамнез: симптомы 2 года, периодические обострения"
→ "Периодические" - не конкретно! → Подпункт 4, Б, confidence 0.6

✅ ДОСТАТОЧНО (можно применять пп. 3, confidence > 0.8):
"Хронический гастродуоденит. Анамнез: обострения 3-4 раза в год"
→ Есть ЯВНАЯ фраза о частоте → Подпункт 3, Д, confidence 0.9

✅ ДОСТАТОЧНО (можно применять пп. 3, confidence > 0.8):
"Анамнез: частые обострения (3 раза за последний год), последнее обострение 2 недели назад"
→ Есть ЯВНОЕ указание на ≥3 обострений/год → Подпункт 3, Д, confidence 0.9

ФОРМАТ ОТВЕТА (JSON):
{{
  "article": <номер статьи или null>,
  "subpoint": "<подпункт СТРОГО по справочнику (1, 2, 3, 4 и т.д.) или null>",
  "confidence": <уверенность от 0 до 1>,
  "reasoning": "<детальное объяснение почему именно этот подпункт подходит>",
  "matched_criteria": "<какие именно критерии совпали>",
  "parameters_matched": {{<ключевые параметры, которые совпали>}},
  "available_subpoints": [<список всех доступных подпунктов для данной статьи>],
  "data_insufficiency": <true если данных недостаточно, false если достаточно>,
  "missing_parameters": [<список недостающих параметров, если data_insufficiency=true>],
  "required_examinations": [<список необходимых обследований, если data_insufficiency=true>]
}}

ПРАВИЛО НИЗКОЙ УВЕРЕННОСТИ:
- Если уверенность < 0.7 - ОБЯЗАТЕЛЬНО укажи это в reasoning
- Если не можешь найти точное совпадение критериев - устанавливай confidence < 0.5
- Если параметры не совпадают точно - confidence НЕ ДОЛЖЕН быть выше 0.6"""

    # Промпт для определения категории
    CATEGORY_DETERMINATION_PROMPT = """Ты - эксперт по военно-врачебной экспертизе Республики Казахстан.
Твоя задача - определить категорию годности призывника на основе статьи и подпункта.

ВАЖНО:
1. Используй данные из таблицы категорий (PointDiagnosis)
2. Учитывай график призывника (граф 1-4):
   - Граф 1: Обычные призывники
   - Граф 2: Курсанты военных учебных заведений
   - Граф 3: Офицеры запаса
   - Граф 4: Спецназ и специальные подразделения
3. Категории: А (годен), Б (годен с ограничениями), В (ограниченно годен),
   Г (временно не годен), Д (не годен), НГ (не годен к призыву)

ФОРМАТ ОТВЕТА (JSON):
{{
  "category": "<категория>",
  "graph": <номер графы>,
  "confidence": <уверенность от 0 до 1>,
  "reasoning": "<объяснение>",
  "alternative_categories": [<список альтернативных категорий при низкой уверенности>]
}}"""

    # Промпт для финального вердикта
    FINAL_VERDICT_PROMPT = """Ты - председатель военно-врачебной комиссии.
Твоя задача - дать финальный вердикт по призывнику на основе всех заключений специалистов.

ВАЖНО:
1. Учти ВСЕ заключения всех врачей-специалистов
2. Если есть расхождения между заключением врача и рекомендацией AI - это КРИТИЧЕСКИЙ РИСК
3. Итоговая категория = НАИХУДШАЯ из всех категорий по разным специалистам
4. Статус risk_level:
   - LOW: все заключения согласованы, нет противоречий
   - MEDIUM: есть пограничные случаи или низкая уверенность
   - HIGH: есть явные расхождения или критические диагнозы

ФОРМАТ ОТВЕТА (JSON):
{{
  "recommended_category": "<итоговая категория>",
  "status": "<MATCH|MISMATCH|REVIEW_REQUIRED>",
  "risk_level": "<LOW|MEDIUM|HIGH>",
  "summary": "<краткая сводка по всем специалистам>",
  "critical_findings": [<список критических находок>],
  "recommendations": "<рекомендации для комиссии>"
}}"""

    @staticmethod
    def _is_healthy_conscript(
        doctor_conclusion: str,
        icd10_codes: Optional[List[str]] = None
    ) -> tuple[bool, str]:
        """
        Проверка, является ли призывник здоровым (без патологий)

        Использует трёхуровневую логику:
        - DEFINITELY_HEALTHY: Явно здоров (есть ключевые слова, нет патологий)
        - UNCERTAIN: Неопределённо (требуется AI-проверка)
        - DEFINITELY_SICK: Явно болен (есть патологии)

        Args:
            doctor_conclusion: Заключение врача
            icd10_codes: Список кодов МКБ-10

        Returns:
            Tuple (is_healthy: bool, confidence: str)
            - is_healthy: True если здоров, False если болен
            - confidence: "high" (уверенно), "uncertain" (нужна AI-проверка)
        """
        conclusion_lower = doctor_conclusion.lower()

        # КРИТИЧЕСКАЯ ПРОВЕРКА: Если есть код МКБ-10 (кроме Z-кодов) → НЕ здоров!
        # Z-коды - это обследования, а не болезни
        if icd10_codes:
            for code in icd10_codes:
                code_upper = code.upper().strip()
                # Игнорируем Z-коды (обследования) и пустые коды
                if code_upper and not code_upper.startswith('Z'):
                    # Найден реальный диагноз - это НЕ здоровый призывник!
                    logger.info(f"🔍 Обнаружен код МКБ-10: {code_upper} → НЕ здоров")
                    return False, "high"

        # Проверяем наличие ключевых слов здоровья
        has_healthy_keywords = any(
            keyword in conclusion_lower
            for keyword in AIAnalyzer.HEALTHY_KEYWORDS
        )

        # Проверяем наличие патологий БЕЗ отрицания
        has_pathology = False
        for keyword in AIAnalyzer.PATHOLOGY_KEYWORDS:
            if keyword in conclusion_lower:
                keyword_pos = conclusion_lower.find(keyword)
                context_before = conclusion_lower[max(0, keyword_pos - 20):keyword_pos]
                negation_words = ["не ", "нет ", "без ", "отсутств"]
                has_negation = any(neg in context_before for neg in negation_words)

                if not has_negation:
                    has_pathology = True
                    break

        # Ключевые слова болезней (даже если вылеченных)
        disease_keywords = [
            "диагноз", "заболевание", "болезнь", "синдром", "недостаточность",
            "нарушение", "деформация", "расстройство", "дисфункция",
            "миопия", "близорукость", "дальнозоркость", "астигматизм"
        ]

        # СПЕЦИАЛЬНАЯ ПРОВЕРКА: Миопия (близорукость) - ВСЕГДА НЕ здоров!
        # Даже если острота зрения 1.0 с коррекцией
        myopia_patterns = [
            r'-\d+\.\d*\s*d',  # -4.5D или -4.5 D
            r'sph\s*-\d+',      # sph -4.5
            r'миопи',           # миопия
            r'близорук'         # близорукость
        ]
        import re
        for pattern in myopia_patterns:
            if re.search(pattern, conclusion_lower):
                # Найдена миопия - это НЕ здоровый призывник!
                return False, "high"

        # СПЕЦИАЛЬНАЯ ПРОВЕРКА: Энурез (ночное недержание мочи) - ВСЕГДА НЕ здоров!
        # Даже если органической патологии не выявлено
        enuresis_patterns = [
            r'энурез',                          # энурез
            r'ночно[ге]\s+недержан',            # ночное недержание, ночного недержания
            r'недержан[ие][ея]\s+моч',          # недержание мочи, недержания мочи
            r'f98\.?0',                         # F98.0 или F980
            r'непроизвольно[ег]\s+мочеиспускан' # непроизвольное мочеиспускание
        ]
        for pattern in enuresis_patterns:
            if re.search(pattern, conclusion_lower):
                # Найден энурез - это НЕ здоровый призывник!
                return False, "high"

        # ИСКЛЮЧЕНИЯ: технические термины, которые НЕ являются болезнями
        # Например: "глазное дно без патологии", "острота зрения в норме"
        technical_terms_not_diseases = [
            "острота зрения", "глазное дно", "внутриглазное давление",
            "барабанные перепонки", "слизистая", "перистальтика",
            "аускультативно", "пальпаторно", "перкуторно"
        ]

        # Проверяем упоминания болезней, но игнорируем технические термины
        has_disease_mention = False
        for keyword in disease_keywords:
            if keyword in conclusion_lower:
                # Проверяем контекст - возможно это НЕ болезнь
                keyword_pos = conclusion_lower.find(keyword)
                context_around = conclusion_lower[max(0, keyword_pos - 30):min(len(conclusion_lower), keyword_pos + 30)]

                # Если рядом есть технический термин - это не болезнь
                is_technical = any(term in context_around for term in technical_terms_not_diseases)
                if not is_technical:
                    has_disease_mention = True
                    break

        # ЛОГИКА ПРИНЯТИЯ РЕШЕНИЯ:

        # 0. Очень короткое заключение (< 50 символов) → НЕОПРЕДЕЛЁННО (нужна AI-проверка)
        # Например: "OD=1.0, OS=1.0" без текстового описания
        if len(conclusion_lower.strip()) < 50:
            return False, "uncertain"

        # 1. Явно болен: есть патологии БЕЗ отрицания
        if has_pathology:
            return False, "high"

        # 2. Явно здоров: есть ключевые слова здоровья И нет упоминаний болезней
        if has_healthy_keywords and not has_disease_mention:
            return True, "high"

        # 3. Пограничный случай: есть упоминания болезней, но с контекстом "вылечен", "санирован" и т.д.
        # Например: "кариес был вылечен", "после лечения"
        healing_keywords = [
            "вылечен", "вылечена", "санирован", "санирована",
            "излечен", "излечена", "после лечения", "проведено лечение",
            "в анамнезе", "ранее перенес", "ранее перенесла"
        ]
        has_healing_context = any(kw in conclusion_lower for kw in healing_keywords)

        if has_disease_mention and has_healing_context:
            # Болезнь упоминается в контексте излечения → НЕОПРЕДЕЛЁННО, нужна AI-проверка
            return False, "uncertain"

        # 4. Есть упоминания болезней без контекста излечения → явно болен
        if has_disease_mention:
            return False, "high"

        # 5. Есть ключевые слова здоровья (без упоминаний болезней) → здоров
        if has_healthy_keywords:
            return True, "high"

        # 6. Ничего не найдено → НЕОПРЕДЕЛЁННО, нужна AI-проверка
        return False, "uncertain"

    @staticmethod
    async def _ai_health_check(doctor_conclusion: str, specialty: str) -> Dict[str, Any]:
        """
        AI-проверка здоровья призывника для неопределённых случаев

        Использует GPT для определения, является ли призывник здоровым,
        когда rule-based метод не уверен.

        Args:
            doctor_conclusion: Заключение врача
            specialty: Специальность врача

        Returns:
            Dict с полями:
            - is_healthy: bool
            - confidence: float (0.0-1.0)
            - reasoning: str
        """
        try:
            user_prompt = f"""Специальность врача: {specialty}

Заключение врача:
{doctor_conclusion}

Определи, является ли призывник ЗДОРОВЫМ (годен к категории А без ограничений)."""

            response = await openai_service.analyze_with_prompt(
                system_prompt=AIAnalyzer.HEALTH_STATUS_CHECK_PROMPT,
                user_content=user_prompt,
                json_mode=True
            )

            result = json.loads(response["content"])

            return {
                "is_healthy": result.get("is_healthy", False),
                "confidence": result.get("confidence", 0.5),
                "reasoning": result.get("reasoning", ""),
                "method": "ai",
                "tokens": response.get("usage", {})
            }

        except Exception as e:
            logger.error(f"Ошибка AI-проверки здоровья: {e}")
            # В случае ошибки считаем призывника НЕ здоровым (безопасная стратегия)
            return {
                "is_healthy": False,
                "confidence": 0.0,
                "reasoning": f"Ошибка AI-проверки: {str(e)}",
                "method": "error",
                "tokens": {}
            }

    @staticmethod
    async def determine_subpoint(
        db: AsyncSession,
        doctor_conclusion: str,
        specialty: str,
        icd10_codes: Optional[List[str]] = None,
        article_hint: Optional[int] = None,
        anamnesis: Optional[str] = None,
        complaints: Optional[str] = None,
        special_research_results: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        Определение подпункта статьи на основе заключения врача

        Args:
            db: Сессия БД
            doctor_conclusion: Заключение врача
            specialty: Специальность врача
            icd10_codes: Коды МКБ-10 (опционально)
            article_hint: Подсказка по статье (опционально)
            anamnesis: Анамнез (история заболевания)
            complaints: Жалобы пациента
            special_research_results: Результаты специальных исследований

        Returns:
            Результат анализа
        """
        start_time = datetime.now()

        try:
            # ============================================================
            # ДВУХУРОВНЕВАЯ ПРОВЕРКА ЗДОРОВЬЯ
            # ============================================================
            # Уровень 1: Rule-based проверка
            is_healthy_rule, confidence_level = AIAnalyzer._is_healthy_conscript(
                doctor_conclusion, icd10_codes
            )

            logger.info(
                f"[HEALTH-CHECK] Rule-based результат: is_healthy={is_healthy_rule}, "
                f"confidence={confidence_level}, specialty={specialty}, "
                f"conclusion_preview='{doctor_conclusion[:100]}...'"
            )

            # Если rule-based метод УВЕРЕННО определил "здоров"
            if is_healthy_rule and confidence_level == "high":
                logger.info(f"[RULE-BASED] ✅ Обнаружен здоровый призывник: {doctor_conclusion[:100]}")

                return {
                    "article": None,
                    "subpoint": None,
                    "confidence": 1.0,
                    "reasoning": (
                        "Призывник здоров, патологии не выявлены. "
                        "Согласно Приказу №722, при отсутствии патологий призывник "
                        "получает категорию А (годен к военной службе) без указания "
                        "статьи расписания болезней."
                    ),
                    "matched_criteria": "Отсутствие патологий",
                    "parameters_matched": {"status": "healthy"},
                    "is_healthy": True,
                    "category": "А",
                    "metadata": {
                        "model": "rule-based",
                        "tokens": {"prompt": 0, "completion": 0, "total": 0},
                        "duration_seconds": (datetime.now() - start_time).total_seconds(),
                        "context_used": False,
                        "validation_performed": False,
                        "detection_method": "keyword-based"
                    }
                }

            # Если rule-based метод НЕ УВЕРЕН (uncertain) → Уровень 2: AI-проверка
            if confidence_level == "uncertain":
                logger.info(f"[UNCERTAIN] Rule-based метод не уверен, запускаем AI-проверку: {doctor_conclusion[:100]}")

                ai_check = await AIAnalyzer._ai_health_check(doctor_conclusion, specialty)

                # Если AI определил "здоров" с высокой уверенностью (≥ 0.7)
                if ai_check["is_healthy"] and ai_check["confidence"] >= 0.7:
                    logger.info(f"[AI-CHECK] AI подтвердил здоровье призывника (confidence: {ai_check['confidence']})")

                    return {
                        "article": None,
                        "subpoint": None,
                        "confidence": ai_check["confidence"],
                        "reasoning": (
                            f"{ai_check['reasoning']}\n\n"
                            "Согласно Приказу №722, при отсутствии патологий призывник "
                            "получает категорию А (годен к военной службе) без указания "
                            "статьи расписания болезней."
                        ),
                        "matched_criteria": "Отсутствие патологий (подтверждено AI)",
                        "parameters_matched": {"status": "healthy"},
                        "is_healthy": True,
                        "category": "А",
                        "metadata": {
                            "model": "gpt-4o-mini",
                            "tokens": ai_check["tokens"],
                            "duration_seconds": (datetime.now() - start_time).total_seconds(),
                            "context_used": False,
                            "validation_performed": True,
                            "detection_method": "ai-assisted"
                        }
                    }
                else:
                    logger.info(f"[AI-CHECK] AI определил призывника как БОЛЬНОГО или не уверен (is_healthy={ai_check['is_healthy']}, confidence={ai_check['confidence']})")
                    # Продолжаем обычный анализ для определения подпункта

            # Формируем запрос для RAG
            query_text = f"{doctor_conclusion}"
            if icd10_codes:
                query_text += f" Диагнозы: {', '.join(icd10_codes)}"

            # УНИВЕРСАЛЬНАЯ ЛОГИКА: Определяем статью по МКБ-10 коду
            if not article_hint and icd10_codes:
                for icd_code in icd10_codes:
                    # Используем универсальный маппер МКБ-10 → Статья
                    mapped_article = icd10_mapper.get_article_by_icd10(icd_code)
                    if mapped_article:
                        article_hint = mapped_article
                        break

            # Получаем релевантный контекст
            context = await rag_service.build_rag_context(
                db, query_text, article=article_hint, include_knowledge=False
            )

            # Формируем промпт для модели с ПОЛНЫМИ данными от врача
            user_prompt_parts = [f"СПЕЦИАЛЬНОСТЬ: {specialty}"]

            # Добавляем жалобы (если есть)
            if complaints and complaints.strip():
                user_prompt_parts.append(f"\nЖАЛОБЫ ПАЦИЕНТА:\n{complaints}")

            # Добавляем анамнез (если есть) - КРИТИЧЕСКИ ВАЖНО для понимания контекста!
            if anamnesis and anamnesis.strip():
                user_prompt_parts.append(f"\nАНАМНЕЗ (история заболевания):\n{anamnesis}")

            # Добавляем заключение врача (ОСНОВНОЕ ПОЛЕ)
            user_prompt_parts.append(f"\nЗАКЛЮЧЕНИЕ ВРАЧА:\n{doctor_conclusion}")

            # Добавляем результаты специальных исследований (если есть)
            if special_research_results and special_research_results.strip():
                user_prompt_parts.append(f"\nРЕЗУЛЬТАТЫ СПЕЦИАЛЬНЫХ ИССЛЕДОВАНИЙ:\n{special_research_results}")

            # Добавляем коды МКБ-10
            user_prompt_parts.append(f"\nКОДЫ МКБ-10: {', '.join(icd10_codes) if icd10_codes else 'Не указаны'}")

            # КРИТИЧЕСКАЯ ПРОВЕРКА: ВСД (G90.x) НЕ ДОЛЖНА ПОЛУЧАТЬ СТАТЬЮ 24!
            has_vsd = icd10_codes and any(code.startswith("G90") for code in icd10_codes)
            if has_vsd:
                user_prompt_parts.append(
                    "\n🚨🚨🚨 КРИТИЧЕСКОЕ УКАЗАНИЕ: Обнаружен код МКБ-10 G90.x (ВЕГЕТО-СОСУДИСТАЯ ДИСТОНИЯ)!\n"
                    "ВСД - это ФУНКЦИОНАЛЬНОЕ расстройство, НЕ органическое сосудистое заболевание!\n"
                    "ЗАПРЕЩЕНО применять статью 24 (болезни сосудов мозга) к ВСД!\n"
                    "Статья 24 применяется ТОЛЬКО к органическим поражениям (инсульт, ТИА, аневризма и т.д.).\n\n"
                    "Если в анамнезе/заключении НЕТ упоминаний об обмороках/синкопальных состояниях:\n"
                    "- article: null\n"
                    "- subpoint: null\n"
                    "- reasoning: 'ВСД без обмороков - категория А'\n"
                    "- is_healthy: false\n\n"
                    "ВНИМАНИЕ: Тахикардия, головокружение, сердцебиение - это НЕ обмороки!"
                )

            # КРИТИЧЕСКАЯ ПРОВЕРКА: ЭНУРЕЗ (F98.0) - ЭТО ДИАГНОЗ, А НЕ "ЗДОРОВ"!
            has_enuresis = icd10_codes and any(code.upper().replace(".", "") == "F980" or code.upper() == "F98.0" for code in icd10_codes)
            if has_enuresis:
                user_prompt_parts.append(
                    "\n🚨🚨🚨 КРИТИЧЕСКОЕ УКАЗАНИЕ: Обнаружен код МКБ-10 F98.0 (ЭНУРЕЗ - НОЧНОЕ НЕДЕРЖАНИЕ МОЧИ)!\n"
                    "ЭНУРЕЗ - это ФУНКЦИОНАЛЬНОЕ РАССТРОЙСТВО, НЕ \"отсутствие патологии\"!\n"
                    "⚠️ ЗАПРЕЩЕНО признавать призывника ЗДОРОВЫМ (категория А) при наличии энуреза!\n\n"
                    "КРИТИЧЕСКИ ВАЖНО:\n"
                    "- 'Органической патологии не выявлено' ≠ 'Здоров'!\n"
                    "- 'УЗИ в норме' ≠ 'Нет заболевания'!\n"
                    "- 'Неврологический статус без патологии' ≠ 'Нет диагноза'!\n\n"
                    "Энурез - это САМОСТОЯТЕЛЬНОЕ ЗАБОЛЕВАНИЕ, даже при отсутствии органики!\n\n"
                    "Если в анамнезе/заключении подтверждается энурез с резистентностью к терапии:\n"
                    "- article: 88\n"
                    "- subpoint: null\n"
                    "- category: Д (для графы I)\n"
                    "- reasoning: 'Первичный ночной энурез, резистентный к терапии...'\n"
                    "- is_healthy: false\n\n"
                    "ОБЯЗАТЕЛЬНО применяй статью 88!"
                )

            # Добавляем контекст из RAG
            user_prompt_parts.append(f"\nРЕЛЕВАНТНЫЙ КОНТЕКСТ:\n{context}")

            # Инструкция для AI
            user_prompt_parts.append("\nОпредели подпункт статьи, учитывая ВСЕ данные выше (жалобы, анамнез, заключение, исследования).")

            user_prompt = "\n".join(user_prompt_parts)

            # Вызываем AI
            response = await openai_service.analyze_with_prompt(
                system_prompt=AIAnalyzer.SUBPOINT_DETERMINATION_PROMPT,
                user_content=user_prompt,
                json_mode=True
            )

            # Парсим ответ
            result = json.loads(response["content"])

            # Преобразуем subpoint в строку, если он пришел как int
            if result.get("subpoint") is not None:
                result["subpoint"] = str(result["subpoint"])

            # 🛡️ ЗАЩИТА ОТ (None, None): Если AI не определила статью, но МКБ-10 известен
            logger.info(f"🛡️ ЗАЩИТА: result.article={result.get('article')}, icd10_codes={icd10_codes}")
            if not result.get("article") and icd10_codes:
                logger.warning(f"🛡️ AI вернула None, пытаемся определить статью по МКБ-10: {icd10_codes}")
                for icd_code in icd10_codes:
                    mapped_article = icd10_mapper.get_article_by_icd10(icd_code)
                    logger.info(f"🛡️ Маппинг {icd_code} → статья {mapped_article}")
                    if mapped_article:
                        logger.warning(
                            f"AI вернула article=None, но МКБ-10 код {icd_code} "
                            f"соответствует статье {mapped_article}. Используем маппинг."
                        )
                        result["article"] = mapped_article
                        result["reasoning"] = (
                            f"⚠️ AI не смогла определить статью, но код МКБ-10 {icd_code} "
                            f"автоматически сопоставлен со статьей {mapped_article}. "
                            f"{result.get('reasoning', '')}"
                        )
                        result["auto_mapped_from_icd10"] = True
                        break

            # КРИТИЧЕСКАЯ ВАЛИДАЦИЯ: Проверяем существование подпункта
            if result.get("article") and result.get("subpoint"):
                validation = await criteria_validator.validate_and_suggest(
                    db=db,
                    article=result["article"],
                    subpoint=result["subpoint"],
                    diagnosis_text=doctor_conclusion,
                    icd10_codes=icd10_codes
                )

                if not validation.is_valid:
                    # ЖЁСТКАЯ ВАЛИДАЦИЯ: Подпункт НЕ существует - ОТКЛОНЯЕМ результат AI
                    logger.error(
                        f"AI предложил несуществующий подпункт: "
                        f"статья {result['article']}, подпункт {result['subpoint']}. "
                        f"Ошибка: {validation.error_message}. "
                        f"ОТКЛОНЯЕМ результат и используем лучшую альтернативу из справочника."
                    )

                    # Если есть альтернативы из справочника - используем лучшую
                    if validation.matched_criteria and len(validation.matched_criteria) > 0:
                        best_match = validation.matched_criteria[0]
                        result["article"] = best_match.get("article")
                        result["subpoint"] = str(best_match.get("subpoint"))
                        result["confidence"] = best_match.get("similarity", 0.5)
                        result["reasoning"] = (
                            f"⚠️ AI предложил несуществующую комбинацию (статья {result.get('article')}, "
                            f"подпункт {result.get('subpoint')}). "
                            f"Заменено на наиболее подходящий вариант из справочника: "
                            f"статья {best_match.get('article')}, подпункт {best_match.get('subpoint')}. "
                            f"Совпадение критериев: {best_match.get('criteria_text', 'N/A')[:200]}"
                        )
                        result["validation_error"] = validation.error_message
                        result["corrected_by_validation"] = True
                        result["original_ai_suggestion"] = {
                            "article": result.get("article"),
                            "subpoint": result.get("subpoint")
                        }
                    else:
                        # Альтернатив нет - устанавливаем null
                        result["article"] = None
                        result["subpoint"] = None
                        result["confidence"] = 0.0
                        result["reasoning"] = (
                            f"⚠️ ОШИБКА ВАЛИДАЦИИ: AI предложил несуществующую комбинацию "
                            f"(статья {result.get('article')}, подпункт {result.get('subpoint')}). "
                            f"В справочнике Приказа №722 такая комбинация отсутствует. "
                            f"Альтернативы не найдены. Требуется ручная проверка врача."
                        )
                        result["validation_error"] = validation.error_message
                        result["rejected_by_validation"] = True
                else:
                    # Подпункт существует - добавляем информацию о категориях
                    result["validated"] = True
                    result["categories_from_handbook"] = validation.categories

            # Добавляем метаданные
            duration = (datetime.now() - start_time).total_seconds()
            result["metadata"] = {
                "model": response["model"],
                "tokens": response["tokens"],
                "duration_seconds": duration,
                "context_used": len(context) > 0,
                "validation_performed": True
            }

            # Логируем запрос
            await AIAnalyzer._log_request(
                db=db,
                request_type="subpoint_determination",
                prompt=user_prompt[:500],  # Сокращаем для логов
                response=response["content"],
                tokens_used=response["tokens"]["total"],
                duration_seconds=duration
            )

            return result

        except Exception as e:
            logger.error(f"Ошибка при определении подпункта: {e}")
            raise

    @staticmethod
    async def determine_category(
        db: AsyncSession,
        article: int,
        subpoint: str,
        graph: int = 1
    ) -> Dict[str, Any]:
        """
        Определение категории годности из справочника (НЕ от AI!)

        Args:
            db: Сессия БД
            article: Номер статьи
            subpoint: Подпункт
            graph: График (1-4)

        Returns:
            Категория годности
        """
        try:
            # СТРОГО по справочнику - сначала валидируем
            validation = await criteria_validator.validate_article_subpoint(
                db=db,
                article=article,
                subpoint=subpoint
            )

            if not validation.is_valid:
                # Подпункт не существует - возвращаем ошибку
                return {
                    "category": None,
                    "graph": graph,
                    "confidence": 0.0,
                    "reasoning": validation.error_message,
                    "alternative_categories": [],
                    "error": "INVALID_SUBPOINT"
                }

            # Получаем категорию из справочника
            category = validation.categories.get(graph)

            # ОТЛАДКА ДЛЯ СТАТЬИ 88
            logger.info(
                f"🔍 determine_category: article={article}, subpoint={subpoint}, graph={graph}, "
                f"validation.is_valid={validation.is_valid}, "
                f"validation.categories={validation.categories}, "
                f"category={category}"
            )

            # 🛡️ ВАЛИДАЦИЯ КАТЕГОРИИ: Проверяем допустимость категории для статьи
            if category and not category_validator.is_category_valid(article, category, graph):
                valid_categories = category_validator.get_valid_categories(article, graph)
                suggested = category_validator.suggest_alternative_category(article, category, graph)

                logger.error(
                    f"❌ Недопустимая категория {category} для статьи {article}! "
                    f"Допустимые категории: {', '.join(valid_categories)}. "
                    f"Предлагаемая альтернатива: {suggested}"
                )

                # Если есть альтернатива - используем её
                if suggested:
                    logger.warning(f"Заменяем категорию {category} на {suggested}")
                    category = suggested

            if not category:
                logger.warning(
                    f"⚠️ Для статьи {article}, подпункт {subpoint}, граф {graph} "
                    f"категория не определена в справочнике. "
                    f"validation.categories={validation.categories}"
                )

            # Получаем описание категории из справочника category_dictionary
            category_info = None
            if category:
                category_info = await criteria_validator.get_category_description(db, category)

            # Формируем расширенный reasoning с описанием категории
            reasoning = f"Категория '{category}' определена СТРОГО из справочника Приказа №722: статья {article}, подпункт {subpoint}, граф {graph}"
            if category_info:
                reasoning += f". {category_info['name']}"

            return {
                "category": category,
                "category_info": category_info,  # Полное описание категории
                "graph": graph,
                "confidence": 1.0 if category else 0.0,
                "reasoning": reasoning,
                "source": "HANDBOOK",  # Подчеркиваем, что это из справочника
                "all_categories": validation.categories,  # Все категории для разных графов
                "alternative_categories": []
            }

        except Exception as e:
            logger.error(f"Ошибка при определении категории: {e}")
            raise

    @staticmethod
    async def analyze_examination(
        db: AsyncSession,
        doctor_conclusion: str,
        specialty: str,
        doctor_category: str,
        icd10_codes: Optional[List[str]] = None,
        graph: int = 1,
        conscript_draft_id: Optional[str] = None,
        examination_id: Optional[str] = None,
        anamnesis: Optional[str] = None,
        complaints: Optional[str] = None,
        special_research_results: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        Полный анализ заключения врача

        Args:
            db: Сессия БД
            doctor_conclusion: Заключение врача
            specialty: Специальность
            doctor_category: Категория, поставленная врачом
            icd10_codes: Коды МКБ-10
            graph: График призывника
            conscript_draft_id: ID призыва
            examination_id: ID обследования
            anamnesis: Анамнез (история заболевания)
            complaints: Жалобы пациента
            special_research_results: Результаты специальных исследований

        Returns:
            Полный результат анализа
        """
        try:
            # Шаг 1: Определяем подпункт
            subpoint_result = await AIAnalyzer.determine_subpoint(
                db=db,
                doctor_conclusion=doctor_conclusion,
                specialty=specialty,
                icd10_codes=icd10_codes,
                anamnesis=anamnesis,
                complaints=complaints,
                special_research_results=special_research_results
            )

            # Шаг 2: Определяем категорию
            if subpoint_result.get("is_healthy"):
                # Здоровый призывник - категория А
                # Получаем описание категории А из справочника
                category_a_info = await criteria_validator.get_category_description(db, "А")
                category_result = {
                    "category": "А",
                    "category_info": category_a_info,
                    "graph": graph,
                    "confidence": 1.0,
                    "reasoning": f"Призывник здоров - категория А ({category_a_info['name'] if category_a_info else 'годен к военной службе'})",
                    "source": "HEALTHY_RULE",
                    "alternative_categories": []
                }
            elif not subpoint_result.get("article") and not subpoint_result.get("subpoint"):
                # Случай, когда article=null и subpoint=null (например, ВСД без обмороков)
                # Проверяем:
                # 1. Явно указана категория в subpoint_result
                # 2. В reasoning есть упоминание категории А
                # 3. Код МКБ-10 = G90.x (ВСД)
                reasoning = subpoint_result.get("reasoning", "").lower()
                has_category_a_mention = (
                    "категория а" in reasoning or
                    "категорию а" in reasoning or
                    "годен к военной службе" in reasoning or
                    "категория а (" in reasoning
                )
                has_vsd_code = icd10_codes and any(code.startswith("G90") for code in icd10_codes)
                explicit_category = subpoint_result.get("category")

                logger.info(f"[VSD-CHECK] article=null, subpoint=null detected")
                logger.info(f"[VSD-CHECK] icd10_codes={icd10_codes}")
                logger.info(f"[VSD-CHECK] has_vsd_code={has_vsd_code}")
                logger.info(f"[VSD-CHECK] explicit_category={explicit_category}")
                logger.info(f"[VSD-CHECK] has_category_a_mention={has_category_a_mention}")
                logger.info(f"[VSD-CHECK] reasoning_snippet={reasoning[:200] if reasoning else 'None'}")

                if explicit_category == "А" or has_category_a_mention or has_vsd_code:
                    # ВСД или другое состояние, которое не препятствует службе
                    category_a_info = await criteria_validator.get_category_description(db, "А")
                    category_result = {
                        "category": "А",
                        "category_info": category_a_info,
                        "graph": graph,
                        "confidence": subpoint_result.get("confidence", 0.9),
                        "reasoning": f"Функциональное расстройство, не препятствующее службе - категория А ({category_a_info['name'] if category_a_info else 'годен к военной службе'})",
                        "source": "FUNCTIONAL_DISORDER_RULE",
                        "alternative_categories": []
                    }
                else:
                    # Неопределенный случай
                    category_result = {
                        "category": None,
                        "confidence": 0.0,
                        "reasoning": "Не удалось определить подпункт и категорию"
                    }
            elif subpoint_result.get("article"):
                # Статья определена - определяем категорию
                # Подпункт может быть None для некоторых статей (например, статья 88 - Энурез)
                logger.info(
                    f"🔍 analyze_examination: вызов determine_category для article={subpoint_result.get('article')}, "
                    f"subpoint={subpoint_result.get('subpoint')}"
                )
                category_result = await AIAnalyzer.determine_category(
                    db=db,
                    article=subpoint_result["article"],
                    subpoint=subpoint_result.get("subpoint"),  # может быть None
                    graph=graph
                )
                logger.info(
                    f"🔍 analyze_examination: результат determine_category: category={category_result.get('category')}, "
                    f"confidence={category_result.get('confidence')}"
                )
            else:
                # Статья не определена - категорию определить невозможно
                logger.warning(
                    f"⚠️ analyze_examination: статья не определена! subpoint_result={subpoint_result}"
                )
                category_result = {
                    "category": None,
                    "confidence": 0.0,
                    "reasoning": "Не удалось определить статью"
                }

            # Шаг 3: Сравниваем с заключением врача
            ai_category = category_result.get("category")
            status = "MATCH" if ai_category == doctor_category else "MISMATCH"

            # Получаем описание категории врача из справочника
            doctor_category_info = await criteria_validator.get_category_description(db, doctor_category)

            # Определяем уровень риска
            risk_level = AIAnalyzer._calculate_risk_level(
                doctor_category=doctor_category,
                ai_category=ai_category,
                subpoint_confidence=subpoint_result.get("confidence", 0),
                category_confidence=category_result.get("confidence", 0)
            )

            # Формируем итоговый результат
            analysis_result = {
                "specialty": specialty,
                "doctor_category": doctor_category,
                "doctor_category_info": doctor_category_info,  # Описание категории врача
                "ai_recommended_category": ai_category,
                "ai_category_info": category_result.get("category_info"),  # Описание рекомендованной категории
                "status": status,
                "risk_level": risk_level,
                "article": subpoint_result.get("article"),
                "subpoint": subpoint_result.get("subpoint"),
                "reasoning": f"{subpoint_result.get('reasoning', '')} | {category_result.get('reasoning', '')}",
                "confidence": min(
                    subpoint_result.get("confidence", 0),
                    category_result.get("confidence", 0)
                ),
                "subpoint_details": subpoint_result,
                "category_details": category_result
            }

            # Сохраняем результат в БД (если указаны ID)
            if conscript_draft_id and examination_id:
                await AIAnalyzer._save_analysis_result(
                    db=db,
                    conscript_draft_id=conscript_draft_id,
                    examination_id=examination_id,
                    analysis_result=analysis_result
                )

            return analysis_result

        except Exception as e:
            logger.error(f"Ошибка при анализе заключения: {e}")
            raise

    @staticmethod
    def _calculate_risk_level(
        doctor_category: str,
        ai_category: Optional[str],
        subpoint_confidence: float,
        category_confidence: float
    ) -> str:
        """
        Расчет уровня риска

        Returns:
            LOW, MEDIUM, HIGH
        """
        # HIGH risk: несовпадение категорий
        if ai_category and doctor_category != ai_category:
            return "HIGH"

        # СПЕЦИАЛЬНОЕ ПРАВИЛО: Если категории совпадают (особенно А=А для здоровых) - это LOW risk
        # Даже при низкой уверенности, если врач и ИИ согласны - это не требует срочной проверки
        if ai_category and doctor_category == ai_category:
            # Категория А (здоровый) при совпадении - всегда LOW risk
            if doctor_category == "А":
                return "LOW"

            # Для других категорий при совпадении:
            # - Высокая уверенность (≥0.7) → LOW
            # - Средняя уверенность (0.5-0.7) → MEDIUM
            # - Низкая уверенность (<0.5) → MEDIUM (не HIGH, т.к. категории совпадают)
            avg_confidence = (subpoint_confidence + category_confidence) / 2
            if avg_confidence >= 0.7:
                return "LOW"
            else:
                return "MEDIUM"

        # HIGH risk: очень низкая уверенность И нет совпадения категорий
        if subpoint_confidence < 0.5 or category_confidence < 0.5:
            return "HIGH"

        # MEDIUM risk: средняя уверенность
        if subpoint_confidence < 0.7 or category_confidence < 0.7:
            return "MEDIUM"

        # LOW risk: все хорошо
        return "LOW"

    @staticmethod
    async def _save_analysis_result(
        db: AsyncSession,
        conscript_draft_id: str,
        examination_id: str,
        analysis_result: Dict[str, Any]
    ):
        """Сохранение результата анализа в БД"""
        try:
            import uuid as uuid_lib

            # Конвертируем UUID строки в UUID объекты
            draft_uuid = uuid_lib.UUID(conscript_draft_id) if isinstance(conscript_draft_id, str) else conscript_draft_id
            exam_uuid = uuid_lib.UUID(examination_id) if isinstance(examination_id, str) else examination_id

            # Проверяем, существует ли уже результат для этого заключения
            from app.models.medical import SpecialistExamination
            existing_result = await db.execute(
                select(AIAnalysisResult).where(
                    AIAnalysisResult.examination_id == exam_uuid,
                    AIAnalysisResult.specialty == analysis_result.get("specialty")
                )
            )
            existing = existing_result.scalar_one_or_none()

            if existing:
                # Обновляем существующий результат
                existing.doctor_category = analysis_result.get("doctor_category")
                existing.ai_recommended_category = analysis_result.get("ai_recommended_category")
                existing.status = analysis_result.get("status")
                existing.risk_level = analysis_result.get("risk_level")
                existing.article = analysis_result.get("article")
                existing.subpoint = analysis_result.get("subpoint")
                existing.reasoning = analysis_result.get("reasoning")
                existing.confidence = analysis_result.get("confidence")
                existing.model_used = "gpt-4o-mini"

                logger.info(f"AI результат обновлен: examination_id={exam_uuid}, specialty={analysis_result.get('specialty')}")
            else:
                # Создаем новую запись результата анализа
                ai_result = AIAnalysisResult(
                    conscript_draft_id=draft_uuid,
                    examination_id=exam_uuid,
                    specialty=analysis_result.get("specialty"),
                    doctor_category=analysis_result.get("doctor_category"),
                    ai_recommended_category=analysis_result.get("ai_recommended_category"),
                    status=analysis_result.get("status"),
                    risk_level=analysis_result.get("risk_level"),
                    article=analysis_result.get("article"),
                    subpoint=analysis_result.get("subpoint"),
                    reasoning=analysis_result.get("reasoning"),
                    confidence=analysis_result.get("confidence"),
                    model_used="gpt-4o-mini"
                )

                db.add(ai_result)
                logger.info(f"AI результат создан: examination_id={exam_uuid}, specialty={analysis_result.get('specialty')}")

            await db.commit()
            logger.info(f"Результат анализа успешно сохранен в БД")

        except Exception as e:
            logger.error(f"Ошибка при сохранении результата анализа: {e}")
            await db.rollback()

    @staticmethod
    async def _log_request(
        db: AsyncSession,
        request_type: str,
        prompt: str,
        response: str,
        tokens_used: int,
        duration_seconds: float
    ):
        """Логирование AI запроса"""
        # TODO: Реализовать логирование в таблицу AIRequestLog
        pass


# Глобальный экземпляр
ai_analyzer = AIAnalyzer()
