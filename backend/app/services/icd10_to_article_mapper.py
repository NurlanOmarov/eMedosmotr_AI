"""
Универсальный маппинг МКБ-10 → Статья Приказа 722
Автоматическое определение статьи по коду МКБ-10
"""

from typing import Optional, Dict, List
import logging

logger = logging.getLogger(__name__)


class ICD10ToArticleMapper:
    """
    Универсальный маппер МКБ-10 кодов на статьи Приказа 722

    Принцип: Используем структуру МКБ-10 (буквенные диапазоны)
    для определения наиболее вероятной статьи
    """

    # Маппинг диапазонов МКБ-10 на статьи Приказа 722
    # Формат: код_МКБ-10 (первые 2-3 символа): номер_статьи
    ICD10_TO_ARTICLE_MAP: Dict[str, int] = {
        # ========== Глава 1. Инфекционные болезни (A00-B99) ==========
        'B20': 5,   # ВИЧ-инфекция с проявлениями → Статья 5
        'B21': 5,   # ВИЧ-инфекция с проявлениями → Статья 5
        'B22': 5,   # ВИЧ-инфекция с проявлениями → Статья 5
        'B23': 5,   # ВИЧ-инфекция с проявлениями → Статья 5
        'B24': 5,   # ВИЧ-инфекция неуточненная → Статья 5

        'A15': 2,   # Туберкулез органов дыхания → Статья 2
        'A16': 2,   # Туберкулез органов дыхания → Статья 2
        'A17': 22,  # Туберкулез нервной системы → Статья 22 ✅
        'A18': 3,   # Туберкулез других органов → Статья 3
        'A19': 3,   # Милиарный туберкулез → Статья 3

        # ========== Глава 7. Болезни глаза (H00-H59) ==========
        'H52': 34,  # Нарушения рефракции (миопия, дальнозоркость) → Статья 34
        'H521': 34, # Миопия → Статья 34
        'H520': 34, # Дальнозоркость → Статья 34
        'H522': 34, # Астигматизм → Статья 34
        'H53': 35,  # Расстройства зрения → Статья 35
        'H54': 35,  # Слепота и пониженное зрение → Статья 35
        'H40': 32,  # Глаукома → Статья 32 ✅
        'H41': 32,  # Глаукома при болезнях → Статья 32
        'H42': 32,  # Вторичная глаукома → Статья 32
        'H25': 30,  # Катаракта → Статья 30
        'H26': 30,  # Другие катаракты → Статья 30
        'H27': 30,  # Другие болезни хрусталика → Статья 30
        'H28': 30,  # Катаракта при болезнях → Статья 30

        # ========== Глава 13. Болезни костно-мышечной системы (M00-M99) ==========
        'M50': 66,  # Поражения межпозвоночных дисков шейного отдела → Статья 66
        'M51': 66,  # Поражения межпозвоночных дисков других отделов → Статья 66
        'M511': 66, # Грыжа межпозвоночного диска → Статья 66
        'M40': 66,  # Кифоз и лордоз → Статья 66
        'M41': 66,  # Сколиоз → Статья 66
        'M42': 66,  # Остеохондроз позвоночника → Статья 66
        'M21': 68,  # Деформации конечностей → Статья 68
        'M20': 68,  # Деформации пальцев → Статья 68
        'M96': 68,  # Плоскостопие → Статья 68

        # ========== Глава 10. Болезни органов дыхания (J00-J99) ==========
        # Болезни носа, околоносовых пазух, глотки → Статья 48
        'J30': 48,  # Аллергический ринит → Статья 48
        'J31': 48,  # Хронический ринит → Статья 48
        'J32': 48,  # Хронический синусит → Статья 48
        'J33': 48,  # Полип носа → Статья 48
        'J34': 48,  # Другие болезни носа → Статья 48
        'J35': 48,  # Хронические болезни миндалин и аденоидов → Статья 48
        'J350': 48, # Хронический тонзиллит → Статья 48
        'J36': 48,  # Перитонзиллярный абсцесс → Статья 48
        'J37': 48,  # Хронический ларингит и ларинготрахеит → Статья 48
        'J38': 48,  # Болезни голосовых связок и гортани → Статья 48
        'J39': 48,  # Другие болезни верхних дыхательных путей → Статья 48

        # Астма → Статья 51
        'J45': 51,  # Астма → Статья 51
        'J46': 51,  # Астматический статус → Статья 51

        # ХОБЛ и другие болезни легких → Статья 50 ✅
        'J40': 50,  # Бронхит неуточненный → Статья 50
        'J41': 50,  # Хронический бронхит → Статья 50
        'J42': 50,  # Хронический бронхит неуточненный → Статья 50
        'J43': 50,  # Эмфизема → Статья 50
        'J44': 50,  # ХОБЛ → Статья 50 ✅
        'J47': 50,  # Бронхоэктазы → Статья 50
        'J84': 50,  # Интерстициальные болезни легких → Статья 50
        'J96': 50,  # Дыхательная недостаточность → Статья 50

        # ========== Глава 11. Болезни органов пищеварения (K00-K99) ==========
        'K25': 57,  # Язва желудка → Статья 57
        'K26': 57,  # Язва двенадцатиперстной кишки → Статья 57
        'K27': 57,  # Язва неуточненная → Статья 57
        'K28': 57,  # Гастроеюнальная язва → Статья 57

        'K29': 58,  # Гастрит и дуоденит → Статья 58
        'K290': 58, # Острый геморрагический гастрит → Статья 58
        'K291': 58, # Другие острые гастриты → Статья 58
        'K292': 58, # Алкогольный гастрит → Статья 58
        'K293': 58, # Хронический поверхностный гастрит → Статья 58
        'K294': 58, # Хронический атрофический гастрит → Статья 58
        'K295': 58, # Хронический гастрит неуточненный → Статья 58

        'K50': 58,  # Болезнь Крона → Статья 58
        'K51': 58,  # Язвенный колит → Статья 58
        'K52': 58,  # Другие неинфекционные гастроэнтериты и колиты → Статья 58
        'K58': 58,  # Синдром раздраженного кишечника → Статья 58

        # Болезни желчного пузыря и поджелудочной железы → Статья 58
        'K70': 58,  # Алкогольная болезнь печени → Статья 58
        'K71': 58,  # Токсическое поражение печени → Статья 58
        'K72': 58,  # Печеночная недостаточность → Статья 58
        'K73': 58,  # Хронический гепатит → Статья 58
        'K74': 58,  # Фиброз и цирроз печени → Статья 58
        'K75': 58,  # Другие воспалительные болезни печени → Статья 58
        'K76': 58,  # Другие болезни печени → Статья 58
        'K77': 58,  # Поражения печени при болезнях → Статья 58
        'K80': 58,  # Желчнокаменная болезнь → Статья 58 ✅
        'K81': 58,  # Холецистит → Статья 58 ✅
        'K82': 58,  # Другие болезни желчного пузыря → Статья 58 ✅
        'K83': 58,  # Другие болезни желчных путей → Статья 58 ✅
        'K85': 58,  # Острый панкреатит → Статья 58 ✅
        'K86': 58,  # Другие болезни поджелудочной железы → Статья 58 ✅
        'K87': 58,  # Поражения поджелудочной железы при болезнях → Статья 58

        # Грыжи брюшной полости → Статья 59
        'K40': 59,  # Паховая грыжа → Статья 59 ✅
        'K41': 59,  # Бедренная грыжа → Статья 59 ✅
        'K42': 59,  # Пупочная грыжа → Статья 59 ✅
        'K43': 59,  # Вентральная грыжа → Статья 59 ✅
        'K44': 59,  # Диафрагмальная грыжа → Статья 59 ✅
        'K45': 59,  # Другие грыжи брюшной полости → Статья 59 ✅
        'K46': 59,  # Неуточненная грыжа брюшной полости → Статья 59 ✅

        # Геморрой → Статья 60
        'K64': 60,  # Геморрой → Статья 60

        # ========== Глава 9. Болезни системы кровообращения (I00-I99) ==========
        # Гипертоническая болезнь → Статья 43
        'I10': 43,  # Эссенциальная гипертензия → Статья 43
        'I11': 43,  # Гипертензивная болезнь сердца → Статья 43
        'I12': 43,  # Гипертензивная почечная болезнь → Статья 43
        'I13': 43,  # Гипертензивная болезнь сердца и почек → Статья 43
        'I15': 43,  # Вторичная гипертензия → Статья 43

        # Болезни сердца → Статья 42
        'I05': 42,  # Ревматические болезни митрального клапана → Статья 42
        'I06': 42,  # Ревматические болезни аортального клапана → Статья 42
        'I07': 42,  # Ревматические болезни трикуспидального клапана → Статья 42
        'I08': 42,  # Поражение нескольких клапанов → Статья 42
        'I34': 42,  # Неревматические поражения митрального клапана → Статья 42
        'I35': 42,  # Неревматические поражения аортального клапана → Статья 42
        'I36': 42,  # Неревматические поражения трикуспидального клапана → Статья 42
        'I37': 42,  # Поражения клапана легочной артерии → Статья 42

        # ИБС → Статья 44
        'I20': 44,  # Стенокардия → Статья 44
        'I21': 44,  # Острый инфаркт миокарда → Статья 44
        'I22': 44,  # Повторный инфаркт миокарда → Статья 44
        'I23': 44,  # Осложнения после инфаркта → Статья 44
        'I24': 44,  # Другие острые ИБС → Статья 44
        'I25': 44,  # Хроническая ишемическая болезнь сердца → Статья 44
        'I42': 44,  # Кардиомиопатия → Статья 44
        'I50': 44,  # Сердечная недостаточность → Статья 44

        # Болезни вен → Статья 45
        'I80': 45,  # Флебит и тромбофлебит → Статья 45
        'I81': 45,  # Тромбоз портальной вены → Статья 45
        'I82': 45,  # Эмболия и тромбоз других вен → Статья 45
        'I83': 45,  # Варикозное расширение вен нижних конечностей → Статья 45
        'I84': 45,  # Геморрой → Статья 45
        'I85': 45,  # Варикозное расширение вен пищевода → Статья 45
        'I86': 45,  # Варикозное расширение вен других локализаций → Статья 45
        'I87': 45,  # Другие поражения вен → Статья 45
        'I89': 45,  # Другие неинфекционные болезни лимфатических сосудов → Статья 45

        # ========== Глава 6. Болезни нервной системы (G00-G99) ==========
        # Эпилепсия, мигрень, нарушения сна → Статья 21 ✅
        'G40': 21,  # Эпилепсия → Статья 21 ✅
        'G41': 21,  # Эпилептический статус → Статья 21 ✅
        'G43': 21,  # Мигрень → Статья 21 ✅
        'G44': 21,  # Другие синдромы головной боли → Статья 21 ✅
        'G47': 21,  # Нарушения сна → Статья 21

        # Инфекционные болезни нервной системы → Статья 22 ✅
        'G00': 22,  # Бактериальный менингит → Статья 22
        'G35': 22,  # Рассеянный склероз → Статья 22 ✅
        'G36': 22,  # Другая острая диссеминированная демиелинизация → Статья 22
        'G37': 22,  # Другие демиелинизирующие болезни → Статья 22

        # Системные атрофии, экстрапирамидные болезни → Статья 23 ✅
        'G10': 23,  # Болезнь Гентингтона → Статья 23
        'G20': 23,  # Болезнь Паркинсона → Статья 23
        'G80': 23,  # ДЦП → Статья 23 ✅
        'G81': 23,  # Гемиплегия → Статья 23
        'G82': 23,  # Параплегия и тетраплегия → Статья 23
        'G83': 23,  # Другие паралитические синдромы → Статья 23

        # ========== Глава 5. Психические расстройства (F00-F99) ==========
        'F00': 16,  # Деменция при болезни Альцгеймера → Статья 16
        'F01': 16,  # Сосудистая деменция → Статья 16
        'F02': 16,  # Деменция при других болезнях → Статья 16
        'F03': 16,  # Деменция неуточненная → Статья 16

        'F20': 15,  # Шизофрения → Статья 15
        'F30': 15,  # Маниакальный эпизод → Статья 15
        'F31': 15,  # Биполярное расстройство → Статья 15

        'F32': 17,  # Депрессивный эпизод → Статья 17
        'F33': 17,  # Рекуррентное депрессивное расстройство → Статья 17
        'F40': 17,  # Фобические тревожные расстройства → Статья 17
        'F41': 17,  # Другие тревожные расстройства → Статья 17

        # Умственная отсталость → Статья 20
        'F70': 20,  # Умственная отсталость легкая → Статья 20
        'F71': 20,  # Умственная отсталость умеренная → Статья 20
        'F72': 20,  # Умственная отсталость тяжелая → Статья 20
        'F73': 20,  # Умственная отсталость глубокая → Статья 20

        # Энурез → Статья 88 ✅
        'F98': 88,  # Другие поведенческие и эмоциональные расстройства → Статья 88
        'F980': 88, # Энурез неорганической природы → Статья 88 ✅
        'R32': 88,  # Недержание мочи неуточненное → Статья 88
        # Расстройства личности (F60-F69) → Статья 18
        'F60': 18,  # Расстройства личности → Статья 18
        'F600': 18, # Параноидное расстройство личности → Статья 18
        'F601': 18, # Шизоидное расстройство личности → Статья 18
        'F602': 18, # Диссоциальное расстройство личности → Статья 18
        'F603': 18, # Эмоционально неустойчивое расстройство личности → Статья 18
        'F604': 18, # Истерическое расстройство личности → Статья 18
        'F605': 18, # Ананкастное расстройство личности → Статья 18
        'F606': 18, # Тревожное расстройство личности → Статья 18
        'F607': 18, # Зависимое расстройство личности → Статья 18
        'F608': 18, # Другие расстройства личности → Статья 18
        'F609': 18, # Расстройство личности неуточненное → Статья 18
        'F61': 18,  # Смешанные расстройства личности → Статья 18
        'F62': 18,  # Стойкие изменения личности → Статья 18
        'F63': 18,  # Расстройства привычек и влечений → Статья 18
        'F64': 18,  # Расстройства половой идентификации → Статья 18
        'F65': 18,  # Расстройства сексуального предпочтения → Статья 18
        'F66': 18,  # Психологические расстройства, связанные с половым развитием → Статья 18
        'F68': 18,  # Другие расстройства личности → Статья 18
        'F69': 18,  # Расстройство личности неуточненное → Статья 18

        'F10': 19,  # Алкогольная зависимость → Статья 19
        'F11': 19,  # Опиоидная зависимость → Статья 19
        'F12': 19,  # Зависимость от каннабиноидов → Статья 19

        # ========== Глава 4. Болезни эндокринной системы (E00-E90) ==========
        'E10': 13,  # Сахарный диабет 1 типа → Статья 13
        'E11': 13,  # Сахарный диабет 2 типа → Статья 13
        'E66': 13,  # Ожирение → Статья 13
        'E04': 12,  # Эутиреоидный зоб → Статья 12
        'E05': 13,  # Тиреотоксикоз → Статья 13

        # ========== Глава 14. Болезни мочеполовой системы (N00-N99) ==========
        # Болезни почек → Статья 71
        'N00': 71,  # Острый нефритический синдром → Статья 71
        'N01': 71,  # Быстропрогрессирующий нефритический синдром → Статья 71
        'N02': 71,  # Рецидивирующая и устойчивая гематурия → Статья 71
        'N03': 71,  # Хронический нефритический синдром → Статья 71
        'N04': 71,  # Нефротический синдром → Статья 71
        'N05': 71,  # Нефритический синдром неуточненный → Статья 71
        'N10': 71,  # Острый тубулоинтерстициальный нефрит (пиелонефрит) → Статья 71
        'N11': 71,  # Хронический тубулоинтерстициальный нефрит (пиелонефрит) → Статья 71
        'N12': 71,  # Тубулоинтерстициальный нефрит неуточненный → Статья 71
        'N13': 71,  # Обструктивная уропатия → Статья 71
        'N14': 71,  # Лекарственная и токсическая нефропатия → Статья 71
        'N15': 71,  # Другие тубулоинтерстициальные болезни почек → Статья 71
        'N18': 71,  # Хроническая болезнь почек → Статья 71
        'N19': 71,  # Почечная недостаточность неуточненная → Статья 71

        # Мочекаменная болезнь → Статья 72
        'N20': 72,  # Камни почки и мочеточника → Статья 72
        'N21': 72,  # Камни нижних отделов мочевых путей → Статья 72
        'N22': 72,  # Камни мочевых путей при болезнях → Статья 72
        'N23': 72,  # Почечная колика неуточненная → Статья 72

        # Болезни половых органов → Статья 73
        'N40': 73,  # Гиперплазия предстательной железы → Статья 73
        'N41': 73,  # Воспалительные болезни предстательной железы → Статья 73
        'N42': 73,  # Другие болезни предстательной железы → Статья 73
        'N43': 73,  # Гидроцеле и сперматоцеле → Статья 73
        'N44': 73,  # Перекрут яичка → Статья 73
        'N45': 73,  # Орхит и эпидидимит → Статья 73
        'N46': 73,  # Мужское бесплодие → Статья 73
        'N47': 73,  # Избыточная крайняя плоть, фимоз и парафимоз → Статья 73
        'N48': 73,  # Другие болезни полового члена → Статья 73
        'N49': 73,  # Воспалительные болезни мужских половых органов → Статья 73
        'N50': 73,  # Другие болезни мужских половых органов → Статья 73

        # ========== Глава 12. Болезни кожи (L00-L99) ==========
        'L20': 62,  # Атопический дерматит → Статья 62
        'L21': 62,  # Себорейный дерматит → Статья 62
        'L30': 62,  # Другие дерматиты → Статья 62
        'L40': 62,  # Псориаз → Статья 62
        'L50': 62,  # Крапивница → Статья 62
        'L70': 62,  # Угри → Статья 62
        'L80': 62,  # Витилиго → Статья 62
        'L90': 62,  # Атрофические изменения кожи → Статья 62

        # ========== Глава 3. Болезни крови (D50-D89) → Статья 11 ✅ ==========
        'D50': 11,  # Железодефицитная анемия → Статья 11 ✅
        'D51': 11,  # Витамин-B12-дефицитная анемия → Статья 11 ✅
        'D52': 11,  # Фолиеводефицитная анемия → Статья 11 ✅
        'D53': 11,  # Другие алиментарные анемии → Статья 11 ✅
        'D55': 11,  # Анемия вследствие ферментных нарушений → Статья 11 ✅
        'D56': 11,  # Талассемия → Статья 11 ✅
        'D57': 11,  # Серповидноклеточная анемия → Статья 11 ✅
        'D58': 11,  # Другие наследственные гемолитические анемии → Статья 11 ✅
        'D59': 11,  # Приобретенная гемолитическая анемия → Статья 11 ✅
        'D60': 11,  # Приобретенная чистая красноклеточная аплазия → Статья 11 ✅
        'D61': 11,  # Другие апластические анемии → Статья 11 ✅
        'D64': 11,  # Другие анемии → Статья 11 ✅
        'D65': 11,  # ДВС-синдром → Статья 11 ✅
        'D66': 11,  # Наследственный дефицит фактора VIII (гемофилия А) → Статья 11 ✅
        'D67': 11,  # Наследственный дефицит фактора IX (гемофилия В) → Статья 11 ✅
        'D68': 11,  # Другие нарушения свертываемости → Статья 11 ✅
        'D69': 11,  # Пурпура и другие геморрагические состояния → Статья 11 ✅
        'D70': 11,  # Агранулоцитоз → Статья 11 ✅
        'D72': 11,  # Другие болезни белых клеток → Статья 11 ✅
        'D73': 11,  # Болезни селезенки → Статья 11 ✅
        'D80': 11,  # Иммунодефициты с преимущественной недостаточностью антител → Статья 11 ✅
        'D81': 11,  # Комбинированные иммунодефициты → Статья 11 ✅
        'D82': 11,  # Иммунодефициты с другими важными дефектами → Статья 11 ✅
        'D83': 11,  # Общий вариабельный иммунодефицит → Статья 11 ✅
        'D84': 11,  # Другие иммунодефициты → Статья 11 ✅
        'D86': 11,  # Саркоидоз → Статья 11 ✅

        # ========== Глава 8. Болезни уха (H60-H95) ==========
        # Болезни наружного уха → Статья 37 ✅
        'H60': 37,  # Наружный отит → Статья 37 ✅
        'H61': 37,  # Другие болезни наружного уха → Статья 37 ✅
        'H62': 37,  # Поражения наружного уха при других болезнях → Статья 37 ✅

        # Болезни среднего уха → Статья 38 ✅
        'H65': 38,  # Негнойный средний отит → Статья 38 ✅
        'H66': 38,  # Гнойный и неуточненный средний отит → Статья 38 ✅
        'H67': 38,  # Средний отит при болезнях → Статья 38 ✅
        'H68': 38,  # Воспаление и закупорка евстахиевой трубы → Статья 38 ✅
        'H69': 38,  # Другие болезни евстахиевой трубы → Статья 38 ✅
        'H70': 38,  # Мастоидит → Статья 38 ✅
        'H71': 38,  # Холестеатома среднего уха → Статья 38 ✅
        'H72': 38,  # Перфорация барабанной перепонки → Статья 38 ✅
        'H73': 38,  # Другие болезни барабанной перепонки → Статья 38 ✅
        'H74': 38,  # Другие поражения среднего уха → Статья 38 ✅
        'H75': 38,  # Другие болезни среднего уха при болезнях → Статья 38 ✅

        # Вестибулярные расстройства → Статья 39 ✅
        'H81': 39,  # Нарушения вестибулярной функции → Статья 39 ✅

        # Болезни внутреннего уха и тугоухость → Статья 40 ✅
        'H80': 40,  # Отосклероз → Статья 40 ✅
        'H83': 40,  # Другие болезни внутреннего уха → Статья 40 ✅
        'H90': 40,  # Кондуктивная и нейросенсорная потеря слуха → Статья 40 ✅
        'H903': 40, # Нейросенсорная тугоухость двусторонняя → Статья 40 ✅
        'H91': 40,  # Другая потеря слуха → Статья 40 ✅
        'H93': 40,  # Другие болезни уха → Статья 40 ✅
        'H94': 40,  # Другие поражения уха при болезнях → Статья 40 ✅

        # ========== Травмы и внешние причины (S00-T98) ==========
        # Травмы головы → Статья 81
        'S00': 81,  # Поверхностная травма головы → Статья 81
        'S01': 81,  # Открытая рана головы → Статья 81
        'S02': 81,  # Перелом черепа → Статья 81
        'S03': 81,  # Вывих головы → Статья 81
        'S04': 81,  # Травма черепных нервов → Статья 81
        'S05': 81,  # Травма глаза → Статья 81
        'S06': 81,  # Внутричерепная травма → Статья 81
        'S07': 81,  # Размозжение головы → Статья 81
        'S08': 81,  # Травматическая ампутация части головы → Статья 81
        'S09': 81,  # Другие травмы головы → Статья 81

        # Травмы шеи → Статья 82
        'S10': 82,  # Поверхностная травма шеи → Статья 82
        'S11': 82,  # Открытая рана шеи → Статья 82
        'S12': 82,  # Перелом шейного отдела позвоночника → Статья 82
        'S13': 82,  # Вывих шеи → Статья 82
        'S14': 82,  # Травма нервов шеи → Статья 82
        'S15': 82,  # Травма кровеносных сосудов шеи → Статья 82

        # Травмы грудной клетки → Статья 83
        'S20': 83,  # Поверхностная травма грудной клетки → Статья 83
        'S21': 83,  # Открытая рана грудной клетки → Статья 83
        'S22': 83,  # Перелом ребер, грудины → Статья 83
        'S23': 83,  # Вывих грудного отдела позвоночника → Статья 83
        'S24': 83,  # Травма нервов грудного отдела → Статья 83
        'S25': 83,  # Травма кровеносных сосудов груди → Статья 83
        'S26': 83,  # Травма сердца → Статья 83
        'S27': 83,  # Травма других органов грудной клетки → Статья 83

        # Травмы живота → Статья 83
        'S30': 83,  # Поверхностная травма живота → Статья 83
        'S31': 83,  # Открытая рана живота → Статья 83
        'S32': 83,  # Перелом позвоночника → Статья 83
        'S33': 83,  # Вывих поясничного отдела позвоночника → Статья 83
        'S34': 83,  # Травма нервов поясничного отдела → Статья 83
        'S35': 83,  # Травма кровеносных сосудов живота → Статья 83
        'S36': 83,  # Травма органов брюшной полости → Статья 83
        'S37': 83,  # Травма органов таза → Статья 83

        # Травмы плеча и плечевого пояса → Статья 84
        'S40': 84,  # Поверхностная травма плеча → Статья 84
        'S41': 84,  # Открытая рана плеча → Статья 84
        'S42': 84,  # Перелом плеча → Статья 84
        'S43': 84,  # Вывих плеча → Статья 84
        'S44': 84,  # Травма нервов плеча → Статья 84
        'S45': 84,  # Травма кровеносных сосудов плеча → Статья 84
        'S46': 84,  # Травма мышц плеча → Статья 84

        # Травмы предплечья → Статья 84
        'S50': 84,  # Поверхностная травма предплечья → Статья 84
        'S51': 84,  # Открытая рана предплечья → Статья 84
        'S52': 84,  # Перелом предплечья → Статья 84
        'S53': 84,  # Вывих локтя → Статья 84
        'S54': 84,  # Травма нервов предплечья → Статья 84
        'S55': 84,  # Травма кровеносных сосудов предплечья → Статья 84
        'S56': 84,  # Травма мышц предплечья → Статья 84

        # Травмы кисти → Статья 84
        'S60': 84,  # Поверхностная травма кисти → Статья 84
        'S61': 84,  # Открытая рана кисти → Статья 84
        'S62': 84,  # Перелом кисти → Статья 84
        'S63': 84,  # Вывих кисти → Статья 84
        'S64': 84,  # Травма нервов кисти → Статья 84
        'S65': 84,  # Травма кровеносных сосудов кисти → Статья 84
        'S66': 84,  # Травма мышц кисти → Статья 84

        # Травмы бедра → Статья 85
        'S70': 85,  # Поверхностная травма бедра → Статья 85
        'S71': 85,  # Открытая рана бедра → Статья 85
        'S72': 85,  # Перелом бедренной кости → Статья 85
        'S73': 85,  # Вывих бедра → Статья 85
        'S74': 85,  # Травма нервов бедра → Статья 85
        'S75': 85,  # Травма кровеносных сосудов бедра → Статья 85
        'S76': 85,  # Травма мышц бедра → Статья 85

        # Травмы голени → Статья 85
        'S80': 85,  # Поверхностная травма голени → Статья 85
        'S81': 85,  # Открытая рана голени → Статья 85
        'S82': 85,  # Перелом голени → Статья 85
        'S83': 85,  # Вывих колена → Статья 85
        'S84': 85,  # Травма нервов голени → Статья 85
        'S85': 85,  # Травма кровеносных сосудов голени → Статья 85
        'S86': 85,  # Травма мышц голени → Статья 85

        # Травмы стопы → Статья 85
        'S90': 85,  # Поверхностная травма стопы → Статья 85
        'S91': 85,  # Открытая рана стопы → Статья 85
        'S92': 85,  # Перелом стопы → Статья 85
        'S93': 85,  # Вывих стопы → Статья 85
        'S94': 85,  # Травма нервов стопы → Статья 85
        'S95': 85,  # Травма кровеносных сосудов стопы → Статья 85
        'S96': 85,  # Травма мышц стопы → Статья 85

        # Ожоги → Статья 86
        'T20': 86,  # Термический ожог головы и шеи → Статья 86
        'T21': 86,  # Термический ожог туловища → Статья 86
        'T22': 86,  # Термический ожог плеча и верхней конечности → Статья 86
        'T23': 86,  # Термический ожог кисти → Статья 86
        'T24': 86,  # Термический ожог бедра и нижней конечности → Статья 86
        'T25': 86,  # Термический ожог стопы → Статья 86
        'T26': 86,  # Термический ожог глаза → Статья 86
        'T27': 86,  # Термический ожог дыхательных путей → Статья 86
        'T28': 86,  # Термический ожог внутренних органов → Статья 86
        'T29': 86,  # Термический ожог нескольких участков → Статья 86
        'T30': 86,  # Термический ожог неуточненный → Статья 86
        'T31': 86,  # Термический ожог по площади тела → Статья 86
    }

    # Маппинг по первой букве (для общих случаев)
    # Формат: буква главы МКБ-10 → список статей Приказа в порядке приоритета
    CHAPTER_TO_ARTICLE_HINT: Dict[str, List[int]] = {
        # Глава A-B: Инфекционные болезни
        'A': [2, 3, 4, 5, 6],  # Туберкулез, ВИЧ, инфекции
        'B': [5, 2, 3, 6],  # ВИЧ, вирусные гепатиты, другие инфекции

        # Глава C: Новообразования
        'C': [10, 11],  # Злокачественные новообразования
        'D': [7, 8, 9, 10],  # Болезни крови, анемии, доброкачественные опухоли

        # Глава E: Эндокринные болезни
        'E': [13, 12],  # Сахарный диабет, болезни щитовидной железы, ожирение

        # Глава F: Психические расстройства
        'F': [15, 16, 17, 18, 19, 20, 88],  # Шизофрения, депрессия, зависимости, энурез

        # Глава G: Болезни нервной системы
        'G': [22, 23, 24, 25, 26],  # Эпилепсия, рассеянный склероз, мигрень, ДЦП

        # Глава H00-H59: Болезни глаза
        'H': [34, 35, 30, 31, 32, 49, 50],  # Глаз (30-35), ухо (49-50)

        # Глава I: Болезни системы кровообращения
        'I': [42, 43, 44, 45],  # Болезни сердца (42), гипертония (43), ИБС (44), вены (45)

        # Глава J: Болезни органов дыхания
        'J': [48, 49, 51, 52],  # ЛОР (48-49), астма (51), ХОБЛ (52)

        # Глава K: Болезни органов пищеварения
        'K': [57, 58, 59, 60, 61],  # Язва (57), гастрит (58), желчный (59), грыжи (60)

        # Глава L: Болезни кожи
        'L': [62, 63],  # Кожные болезни

        # Глава M: Болезни костно-мышечной системы
        'M': [66, 65, 67, 68],  # Позвоночник (66), артриты (65), плоскостопие (68)

        # Глава N: Болезни мочеполовой системы
        'N': [71, 72, 73, 74, 75],  # Почки (71), камни (72), половые органы (73-75)

        # Глава S: Травмы
        'S': [81, 82, 83, 84, 85],  # Травмы головы (81), шеи (82), груди/живота (83), конечностей (84-85)

        # Глава T: Последствия травм, ожоги, отравления
        'T': [86, 87],  # Ожоги (86), последствия травм (87)
    }

    @classmethod
    def get_article_by_icd10(cls, icd10_code: str) -> Optional[int]:
        """
        Определяет статью Приказа 722 по коду МКБ-10

        Args:
            icd10_code: Код МКБ-10 (например, "H52.1", "M51.2", "I10")

        Returns:
            Номер статьи или None
        """
        if not icd10_code:
            return None

        # Убираем точки, пробелы и приводим к верхнему регистру
        code = icd10_code.replace('.', '').replace(' ', '').upper()

        # Попытка 1: Проверяем точное совпадение (первые 4 символа - для I101, M511 и т.д.)
        if len(code) >= 4:
            prefix_4 = code[:4]
            if prefix_4 in cls.ICD10_TO_ARTICLE_MAP:
                article = cls.ICD10_TO_ARTICLE_MAP[prefix_4]
                logger.info(f"МКБ-10 {icd10_code} → Статья {article} (точное совпадение 4 символа)")
                return article

        # Попытка 2: Проверяем точное совпадение (первые 3 символа - для H52, M51, I10 и т.д.)
        if len(code) >= 3:
            prefix_3 = code[:3]
            if prefix_3 in cls.ICD10_TO_ARTICLE_MAP:
                article = cls.ICD10_TO_ARTICLE_MAP[prefix_3]
                logger.info(f"МКБ-10 {icd10_code} → Статья {article} (точное совпадение 3 символа)")
                return article

        # Попытка 3: Проверяем по первым 2 символам (для общих категорий)
        if len(code) >= 2:
            prefix_2 = code[:2]
            if prefix_2 in cls.ICD10_TO_ARTICLE_MAP:
                article = cls.ICD10_TO_ARTICLE_MAP[prefix_2]
                logger.info(f"МКБ-10 {icd10_code} → Статья {article} (совпадение 2 символа)")
                return article

        # Попытка 4: Проверяем по первой букве (глава МКБ-10) - возвращаем первую статью из списка
        if len(code) >= 1:
            chapter_letter = code[0]
            chapter_hints = cls.CHAPTER_TO_ARTICLE_HINT.get(chapter_letter, [])
            if chapter_hints:
                article = chapter_hints[0]
                logger.info(f"МКБ-10 {icd10_code} → Статья {article} (по главе {chapter_letter})")
                return article

        # Возвращаем None, если нет совпадений
        logger.warning(f"МКБ-10 {icd10_code} - статья не найдена в маппинге")
        return None

    @classmethod
    def get_chapter_hints(cls, icd10_code: str) -> List[int]:
        """
        Возвращает список вероятных статей по главе МКБ-10

        Args:
            icd10_code: Код МКБ-10

        Returns:
            Список вероятных статей
        """
        if not icd10_code:
            return []

        chapter_letter = icd10_code[0].upper()
        return cls.CHAPTER_TO_ARTICLE_HINT.get(chapter_letter, [])


# Глобальный экземпляр
icd10_mapper = ICD10ToArticleMapper()
